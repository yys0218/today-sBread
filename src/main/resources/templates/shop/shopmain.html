<!DOCTYPE html>
<html layout:decorate="~{/common/layout}">
<head>
    <meta charset="UTF-8">
      <meta name="_csrf" th:content="${_csrf.token}"/>
   <meta name="_csrf_header" th:content="${_csrf.headerName}"/> 
    <link rel="stylesheet" href="/css/shop/shopmain.css">   
</head>
<body>
<!-- 판매자가 자신의 상점의 정보를 수정 하거나 상품을 등록할수 있는 곳  -->
<div layout:fragment="content" class="container my-3">

      
<!-- 상점 존재 여부 -->
    <div th:if="${shop != null}">
        <!-- 상단 상점 정보 + 판매 등록 버튼 -->
        <div class="shop-header">      
            <div class="shop-name" id="shop-name" th:text="${shop.shopName}"></div>
            <a th:href="@{/product/insert}">
                <button class="register-btn">상품등록</button>
            </a>    
        </div>


<!-- ================== 상점 부분 탭 메뉴부분 시작  ==================================== -->

<!-- 상점 탭 메뉴 -->
<nav>
    <a href="#" class="active" data-tab="all">전체 상품</a>
    <a href="#" data-tab="notice">알림사항</a>
    <a href="#" data-tab="delivery" id="delivery">배송</a>
    <a href="#" data-tab="orderhistory">판매내역</a>
    <a href="#" data-tab="review">리뷰</a> 
    <a href="#" data-tab="info">판매자정보</a>
</nav>


<!-- ==================== 상점 부분 탭 메뉴 부분 끝 ================== -->
       
<!-- ================= 상품 카드의 상태를 볼수 있는 판매중 , 품절 상태 드롭다운 =================== -->       
       
<!-- 상품 상태를 선택하는 드롭다운 --> 
<select id="statusFilter" name="statusFilter" class="custom-select">
    <option value="all">전체상품</option>
    <option value="selling">판매중</option>
    <option value="soldout">품절</option>
</select>

<!-- 드롭다운 필터링시 , 필터링 결과에 따른 안내 추가 예정?-->


<!-- ===================== 상품 상태에 대한 드롭다운 부분 끝 ======================================== -->

<!--  어느 탭을 가도 고정되어서 나오는 판매자 상점의 알림사항  -->

<!-- 알림 문구 -->
<div class="shopNotice" 
     th:if="${latestNotice != null}" 
     th:text="'알림 : [안내사항] ' + ${latestNotice.shopNoticeTitle}">
</div>


<!-- ======================== 알림사항 문구 부분 끝 ================================ -->

<!-- ======================== 판매자 페이지 전체 상품 부분 시작 ========================= -->
<!-- 전체 상품 출력 -->
<div id="product-area" class="box" style="padding:20px;">
    <div id="product-grid" 
         style="display:flex; flex-wrap:wrap; gap:20px; justify-content:space-between;">

        <!-- 상품이 없을 때 -->
        <div th:if="${productList == null or #lists.isEmpty(productList)}" 
             style="width:100%; text-align:center; color:#888; padding:60px 0;">
            아직 등록된 상품이 없습니다.
        </div>

        <!-- 상품 카드 -->
        <div th:each="product : ${productList}" 
             style="font-family: 'Jua', sans-serif; width:220px;">

            <a th:href="@{|/product/detail/${product.productNo}|}" 
               class="product-card"
               th:attr="data-status=${product.status == 0 ? 'selling' : 'soldout'}"
               style="display:block; text-align:center; font-family: 'Noto Sans KR', sans-serif;
                      border:1px solid #eee; border-radius:10px; background:#fff; padding:10px; margin:0 auto;">

                <!-- 이미지 -->
                <img th:src="@{|/upload/product/${product.thumbnailName}|}" 
                     th:alt="${product.productName}" 
                     style="width:100%; height:220px; object-fit:cover; border-radius:8px;"/>

                <!-- 상품명 -->
                <p th:text="${product.productName}"
                   th:style="${product.status == 1} ? 'color:red; margin-top:10px; font-weight:600; font-size:16px;' 
                                                  : 'color:black; margin-top:10px; font-weight:600; font-size:16px;'">
                </p>

                <!-- 가격 -->
                <p th:text="${product.price} + '원'"
                   th:style="${product.status == 1} ? 'color:red; font-size:14px; margin:5px 0;' 
                                                  : 'color:black; font-size:14px; margin:5px 0;'">
                </p>
            </a>

            <!-- 판매자용 상품 상태 변경 드롭다운 -->
         <div class="status-select-wrapper">
             <form th:action="@{/shop/product/status/update}" method="post">
                 <input type="hidden" name="productNo" th:value="${product.productNo}" />
                    <select name="status" class="custom-select" onchange="this.form.submit()">
                        <option value="0" th:selected="${product.status == 0}">판매중</option>
                        <option value="1" th:selected="${product.status == 1}">품절</option>
                    </select>
             </form>
         </div>
      </div>
    </div>
</div>


<!-- ======================== 판매자 페이지 전체 상품 부분 끝 ========================= -->


<!-- ===================================== 판매자 페이지 알림사항 부분 시작 ====================================== -->

<!-- 알림사항 -->
<div class="tab-content box" id="tab-notice" style="font-family: 'Noto Sans KR', sans-serif; padding: 20px; background: #f9f9f9;">
    <h1 class="text-xl font-bold mb-4">알림사항</h1>

    <!-- 새 알림사항 버튼 -->
    <div class="mb-4" style="text-align: right;">
        <button class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition"
                type="button"
                th:onclick="'location.href=\'' + @{/shop/shopNotice} + '\';'">
            새 알림사항 작성
        </button>
    </div>

    <!-- 알림사항 리스트 -->
<ul class="space-y-2">
    <li th:each="notice : ${noticeList}" class="relative p-2 border rounded flex items-center gap-2">
        <!-- 체크박스 -->
        <input type="checkbox"
               th:checked="${notice.pinned}"
               th:data-notice-no="${notice.shopNoticeNo}"
               class="pin-checkbox"
               onchange="
                   const checkbox = this;
                   const noticeNo = this.dataset.noticeNo;
                   const pinned = checkbox.checked;

                   Swal.fire({
                       title: pinned ? '공지 고정 확인' : '공지 고정 해제 확인',
                       text: pinned ? '이 공지를 고정하시겠습니까?' : '이 공지를 고정 해제하시겠습니까?',
                       icon: 'question',
                       showCancelButton: true,
                       confirmButtonText: '확인',
                       cancelButtonText: '취소'
                   }).then((result) => {
                       if (result.isConfirmed) {
                           // fetch로 바로 DB 저장
                           const csrfToken = document.querySelector('meta[name=_csrf]').getAttribute('content');
                           const csrfHeader = document.querySelector('meta[name=_csrf_header]').getAttribute('content');

                          fetch('/shop/pinNotice', {
                                          method: 'POST',
                                          headers: {
                                           'Content-Type': 'application/json',
                                           [csrfHeader]: csrfToken
                                    },
                     body: JSON.stringify({
                      shopNoticeNo: noticeNo,
                      pinned: pinned
                 }),
                     credentials: 'same-origin'
               })
                           .then(res => res.json())
                           .then(data => {
                               if (!data.success) {
                                   checkbox.checked = !pinned;
                                   Swal.fire('오류', '공지 고정 상태 변경 실패: ' + data.message, 'error');
                               } else {
                                   // 상단 공지 바로 업데이트
                                   let shopNoticeDiv = document.querySelector('.shopNotice');
                                   const noticeTitle = checkbox.closest('li').querySelector('p').innerText;
                                   if (pinned) {
                                       if (!shopNoticeDiv) {
                                           shopNoticeDiv = document.createElement('div');
                                           shopNoticeDiv.classList.add('shopNotice');
                                           document.querySelector('.container').prepend(shopNoticeDiv);
                                       }
                                       shopNoticeDiv.innerText = '알림 : [안내사항] ' + noticeTitle;
                                   } else {
                                       if (shopNoticeDiv) shopNoticeDiv.remove();
                                   }
                                   Swal.fire('완료', '공지 고정 상태가 변경되었습니다!', 'success');
                               }
                           })
                           .catch(err => {
                               console.error(err);
                               checkbox.checked = !pinned;
                               Swal.fire('오류', '네트워크 오류로 변경 실패', 'error');
                           });
                       } else {
                           // 취소 시 체크박스 원상복구
                           checkbox.checked = !checkbox.checked;
                           Swal.fire('취소', '변경이 취소되었습니다.', 'info');
                       }
                   });
               "
        />
        <span class="text-sm text-gray-600">고정으로</span>

        <!-- 알림 내용 -->
        <a th:href="@{|/shop/noticeDetail/${notice.shopNoticeNo}|}"
           class="flex-1 block p-2 hover:underline">
           <p class="font-medium text-gray-800" th:text="${notice.shopNoticeTitle}"></p>
           <p class="text-sm text-gray-500 mt-1" th:text="${#dates.format(notice.createdAt, 'yyyy-MM-dd')}"></p>
        </a>
    </li>
</ul>

   <!-- 알림사항이 없을때 나오는 문구 -->
      <div th:if="${noticeList.empty}" class="p-4 text-center text-gray-400 box">
          아직 알림사항이 없습니다.
      </div>

</div>


<!-- ===================================== 판매자 페이지 알림사항 부분 끝 ====================================== -->

<!-- ===================================== 판매자 페이지 판매내역 부분 시작 ====================================== -->
<!-- 판매내역 탭 -->
<div class="tab-content box" id="tab-orderhistory"
     th:classappend="${tab == 'orderhistory'} ? ' active'"
     style="font-family: 'Noto Sans KR', sans-serif; padding: 20px; background: #f9f9f9;">

<!-- 상단 헤더 -->
<div class="flex justify-between items-center mb-4 header-container">
    <h1 class="text-xl font-bold">판매(주문) 내역</h1>
    <a th:href="@{/shop/totalsales}">
	    <button class="sales-btn">모든 판매내역 보기</button>    
    </a>
</div>


    <!-- 주문 내역 리스트 -->
    <ul th:if="${!#lists.isEmpty(allOrders)}" style="list-style:none; padding:0;">
        <li th:each="sale : ${allOrders}"  th:id="'sale-' + ${sale.orderNo}" th:class="'sale-item status-' + ${sale.status}" 
            class="mb-6 p-4 bg-white rounded shadow">
			
            <!-- 주문 기본 정보 -->
            <div class="mb-1"><b>주문번호:</b> <span th:text="${sale.orderNo}">-</span></div>
            <div class="mb-1"><b>주문일시:</b> 
                <span th:text="${sale.orderTime != null ? #temporals.format(sale.orderTime.orderedAt, 'yyyy-MM-dd HH:mm') : ''}">-</span>
            </div>
            <div class="mb-1"><b>결제번호:</b> <span th:text="${sale.merchantUid}">-</span></div>
            <div class="mb-2"><b>결제금액:</b> <span th:text="${#numbers.formatInteger(sale.orderPrice, 3, 'COMMA')}"></span>원</div>
            
<!--                 <span th:if="${sale.status==-1}">주문취소</span>
                <span th:if="${sale.status==0}">수락대기</span>
                <span th:if="${sale.status==1}">거절</span>
                <span th:if="${sale.status==2}">배송요청</span> -->

            <!-- 주문 품목 테이블 -->
            <table class="w-full border-collapse mb-4">
                <thead>
                    <tr class="bg-gray-100">
                        <th class="border px-2 py-1 text-left">상품명</th>
                        <th class="border px-2 py-1 text-center" style="width:80px;">수량</th>
                        <th class="border px-2 py-1 text-right" style="width:100px;">단가</th>
                        <th class="border px-2 py-1 text-right" style="width:120px;">소계</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="it : ${sale.orderDetail}">
                        <td class="border px-2 py-1">
                            <a th:if="${it.product != null}" 
                               th:href="@{|/product/detail/${it.product.productNo}|}"
                               th:text="${it.product.productName}">상품명</a>
                            <span th:if="${it.product == null}" th:text="'상품번호 ' + ${it.productNo}">상품</span>
                        </td>
                        <td class="border px-2 py-1 text-center" th:text="${it.quantity}"></td>
                        <td class="border px-2 py-1 text-right" th:text="${#numbers.formatInteger(it.price, 3, 'COMMA')} + '원'"></td>
                        <td class="border px-2 py-1 text-right" th:text="${#numbers.formatInteger(it.price * it.quantity, 3, 'COMMA')} + '원'">0원</td>
                    </tr>
                    <tr>
                    	<td colspan="3">
                    		<p>배송비: <span th:text="${sale.deliveryFee}"></span></p>
                    	</td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(sale.orderDetail)}">
                        <td colspan="4" class="text-center text-gray-500">주문 품목이 없습니다.</td>
                    </tr>
                </tbody>
            </table>

			<!-- 주문 상태 -->
            <p class="mb-2"><b>주문 상태:</b> </p>
            <!-- 상태별 카드 -->
            <div class="bg-white shadow-md rounded-2xl p-4 border border-gray-200 mt-4">
                <!-- 주문 수락/거절 (status=0) -->
		         <div th:if="${sale.status == 0}" class="order-buttons justify-center">
		             <form th:action="@{'/shop/' + ${sale.orderNo} + '/accept'}" method="post">
		                 <button type="submit" class="bg-green-500 hover:bg-green-600 text-white">
		                     주문 수락
		                 </button>
		             </form>
		             <form th:action="@{'/shop/' + ${sale.orderNo} + '/reject'}" method="post">
		                 <button type="submit" class="reject-btn">
		                     주문 거절
		                 </button>
		             </form>
		         </div>
                <!-- 주문 거절됨 (status=1) -->
                <div th:if="${sale.status == 1}" class="text-center mt-2">
                    <p class="text-red-500 font-semibold box">주문이 거절되었습니다</p>
                </div>
                <!-- 주문 수락 후 라이더 대기 (status=2) -->
                <div th:if="${sale.status == 2}" class="text-center mt-2">
                    <p class="text-gray-700 font-semibold box">주문을 수락했습니다 (라이더 대기 중)</p>
                </div>
            </div> <!-- 상태별 카드 끝 -->
        </li>
    </ul>

    <!-- 매출 내역이 없는 경우 -->
    <div th:if="${#lists.isEmpty(allSales)}" class="text-center text-gray-500 mt-4">
        아직 매출 내역이 없습니다.
    </div>

</div> <!-- 탭 컨텐츠 끝 -->


<!-- + 총 매출관리 버튼을 클릭 할시 , 주문 거절된 주문 건들도 빨갛게 표시 할 예정   -->
<!-- + 주문 거절 누를시 , 한번더 재 확인 ! 판매자가 이 주문 건을 거절 하는게 맞는건지!  -->

<!-- ===================================== 판매자 페이지 판매내역 부분 끝 ====================================== -->

<!-- =================== 판매자 페이지 배송 부분 ======================================================================== -->
<!-- 배송 -->
<div class="tab-content box" id="tab-delivery">

<h1>배송</h1>

    <!-- 배송중인 주문 목록 -->
    <ul th:if="${!#lists.isEmpty(allSales.?[status == 2])}" id="deliveryList">
        <li th:each="sale : ${allSales.?[status >= 2]}" th:id="'order-' + ${sale.orderNo}"
            class="p-4 border rounded shadow-sm hover:bg-gray-50 transition">

            <!-- 배송 요청된 건부터 출력 -->
            <p>매출번호: <span th:text="${sale.orderNo}"></span></p>
            <!-- <p>상품명: <span th:text="${sale.product != null ? sale.product.productName : '상품없음'}"></span></p> -->
              <p>주문 내역:
            <div th:each="item : ${sale.orderDetail}">
          <p>
                    <span th:text="${item.product != null ? item.product.productName : '상품없음'}"></span> 
                         (<span th:text="${item.quantity}"></span>개) 
          </p>
            </div>

            <p>결제금액: <span th:text="${sale.orderPrice}"></span>원</p>
         <p class="mb-2"><b>배송 상태:</b> </p>
<!-- 배송 진행중 표시 -->
<div class="status-container box">
    <div class="status-indicator box">
        <span th:if="${sale.status==2}">배송요청</span>
        <span th:if="${sale.status==3}">픽업대기</span>
        <span th:if="${sale.status==4}">픽업</span>
        <span th:if="${sale.status==5}">배송완료</span>
    </div>
</div>




    <!-- 배송 중인 주문 없을 때 안내 -->
    <div th:if="${#lists.isEmpty(allSales.?[status == 2])}" class="text-gray-500 text-center p-5 border rounded box">
        배송 중인 주문이 없습니다.
    </div>
</div>


<!-- =================== 판매자 페이지 배송 부분 끝 ========================================================== -->

<!-- =================== 판매자 페이지 리뷰 부분 시작 ========================================================= -->
<!-- 리뷰 탭 -->
<!-- 리뷰 탭 -->
            <div id="tab-review" class="tab-content" style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f5f5f5">
                <!-- 리뷰가 없을 때 -->
                <div th:if="${#lists.isEmpty(reviewList)}" style="text-align: center; color: #888; padding: 60px 0; font-size: 14px">등록된 리뷰가 없습니다.</div>

                <!-- 리뷰가 있을 때 -->
                <ul th:unless="${#lists.isEmpty(reviewList)}" style="list-style: none; padding: 0; margin: 0">
                    <li th:each="review : ${reviewList}" style="margin-bottom: 20px" class="review-card">
                        <a th:href="@{/product/detail/{productNo}(productNo=${review.productNo})}">
                            <!-- 상단 영역: 닉네임 + 작성일 -->
                            <div class="review-header">
                                <span class="review-nick" th:text="${review.memberNick}">작성자</span>
                                <span class="review-date" th:text="${#temporals.format(review.createDate, 'yyyy-MM-dd HH:mm:ss')}">2025-09-15</span>
                            </div>

                            <!-- 본문 영역 -->
                            <div class="review-body">
                                <p class="review-content" th:text="${review.reviewContent}">리뷰 내용</p>
                            </div>
                        </a>
                        <!-- 댓글 영역 -->
                        <div th:if="${review.comments.size() > 0}" th:each="comment : ${review.comments}" class="comment-box">
                            <span class="comment-label">댓글</span>
                            <span class="comment-author">사장님</span>
                            <span class="comment-date" th:text="${#temporals.format(comment.createdAt, 'yyyy-MM-dd HH:mm')}">2025-09-15</span>
                            <p class="comment-content" th:text="${comment.content}">댓글 내용</p>
                        </div>
                        <!-- 각 리뷰 밑의 댓글 달기 버튼 -->
                        <th:block th:if="${review.comments.size() == 0}">
                            <div style="text-align: right; margin-top: 6px">
                                <a
                                    th:href="@{/shop/review/{reviewNo}/comment(reviewNo=${review.reviewNo})}"
                                    style="display: inline-block; padding: 4px 10px; font-size: 12px; color: #3b82f6; background-color: #fff; border: 1px solid #3b82f6; border-radius: 6px; text-decoration: none; transition: all 0.2s ease-in-out"
                                    onmouseover="this.style.backgroundColor='#3b82f6'; this.style.color='#fff';"
                                    onmouseout="this.style.backgroundColor='#fff'; this.style.color='#3b82f6';"
                                >
                                    댓글 달기
                                </a>
                            </div>
                        </th:block>
                    </li>
                </ul>
            </div>



<!-- =================== 판매자 페이지 리뷰 부분 종료 ========================================================= -->

<!-- ===================================== 판매자 페이지 판매자정보 부분 시작 ====================================== -->
<!-- 판매자 정보 탭 -->
<div class="tab-content box" id="tab-info"  style="font-family: 'Noto Sans KR', sans-serif; padding: 20px; background: #f9f9f9;">
    <h1 style="margin-bottom: 20px; font-size: 24px; color: #333;">판매자 정보</h1>
    <div id="shop-info-display" style="display: flex; gap: 40px; flex-wrap: wrap;">

        <!-- 왼쪽: 판매자 정보 수정 폼 -->
        <div class="shop-form" style="flex: 1; min-width: 320px; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 3px 6px rgba(0,0,0,0.1);">
            <form th:action="@{/shop/shopUpdate}" th:object="${shop}" method="post">
                <input type="hidden" th:field="*{shopNo}" />
              
             <div style="display: flex; gap: 10px; margin-bottom: 15px;">               
                <div style="flex: 1;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">가게 이름</label>
                    <input type="text" th:field="*{shopName}" placeholder="실제 가게명과 동일하게 입력해주세요." required style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
                </div>             
               <div style="flex: 1;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">사업자번호</label>
                <input type="text" th:field="*{tinNo}" readonly 
                          style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ccc; background-color:#f5f5f5;">
           </div>                             
         </div>   
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">주소</label>
                    <input type="text" th:field="*{shopAddress}" placeholder="실제 가게주소지와 동일하게 입력해주세요." required style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">가게 연락처</label>
                    <input type="text" th:field="*{shopContact}" placeholder="실제 가게 연락전화번호와 동일하게 입력해주세요." required style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
                </div>

                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <div style="flex: 1;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">영업 오픈시간</label>
                        <input type="text" name="openTime"  th:value="${shop.openTime}" required style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
                    </div>
                    <div style="flex: 1;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">영업 마감시간</label>
                        <input type="text" name="closeTime" th:value="${shop.closeTime}" required style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">상점 소개</label>
                    <input type="text" th:field="*{shopInfo}" placeholder="상점 소개를 적어주세요" required style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">사업자 예금주명</label>
                    <input type="text" th:field="*{businessAccName}" placeholder="정산받을 계좌의 소유주명을 적어주세요" required style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">사업자 계좌번호</label>
                    <input type="text" th:field="*{businessAccNum}" placeholder="정산받을 계좌번호를 정확히 적어주세요" required style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
                </div>
                
                
              <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">가게 배달비</label>
                    <input type="number" th:field="*{deliveryFee}" placeholder="가게 배달비 입니다" required style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
              </div>
                
              <div style="display: flex; gap: 10px;">
                    <button type="submit" style="flex: 1; padding: 10px; background: #f46f40; color: #fff; border: none; border-radius: 5px; cursor: pointer;">저장</button>
                    <button type="button" onclick="history.back()" style="flex: 1; padding: 10px; background: #888888; color: #fff; border: none; border-radius: 5px; cursor: pointer;">취소</button>
              </div>
            </form>
        </div>

        <!-- 오른쪽: 판매자 통계 영역 -->
        <div class="shop-stats" style="flex: 1; min-width: 320px; display: flex; flex-direction: column; gap: 20px;">
            <h4 style="color: #333;">상점 통계</h4>
            <div class="stats-card" style="background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 3px 6px rgba(0,0,0,0.1); text-align: center;">
                <h5 style="margin-bottom: 10px; color: #555;">총 주문 건수</h5>
                <p style="font-size: 24px; font-weight: 700;" th:text="${stats != null && stats.totalOrders != null ? stats.totalOrders : 0}">0</p>
            </div>

            <div class="stats-card" style="background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 3px 6px rgba(0,0,0,0.1); text-align: center;">
                <h5 style="margin-bottom: 10px; color: #555;">총 매출액</h5>
                <p th:text="|${stats != null && stats.totalSales != null ? stats.totalSales : 0}원|">0원</p>
            </div>
        
         <!-- 통계 그래프 영역 -->
         <div class="stats-chart" 
              style="background: #fff; padding: 20px; border-radius: 10px; 
                     box-shadow: 0 3px 6px rgba(0,0,0,0.1); min-width: 300px;">
             <h5 style="margin-bottom: 10px; color: #555; text-align: center;">월간 통계</h5>
             <!-- width/height 인라인 제거 -->
             <canvas id="shopStatsChart"></canvas>
         </div>
                
              <!-- 정산 신청 버튼 -->
               <div style="margin: 20px 0; text-align: center;">
    <form th:action="@{/center/settle/apply}" method="post" id="settleApply">
        <input type="hidden" name="memberNo" th:value="${session.user.memberNo}" />
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <button type="submit" 
                style="padding: 12px 20px; background: #4CAF50; color: #fff;
                       border: none; border-radius: 5px; font-size: 16px; cursor: pointer;">
            정산 신청
        </button>
    </form>
</div>           
                
<div style="margin: 20px 0; text-align: center;">
    <form th:action="@{/shop/{shopNo}/settlements(shopNo=${shop.shopNo})}" method="get" id="viewSales">
        <button type="submit"
                style="padding: 12px 20px; background: #4CAF50; color: #fff;
                       border: none; border-radius: 5px; font-size: 16px; cursor: pointer;">
            정산 내역보기
        </button>
    </form>
</div>

       </div>
  </div>

<!-- ===================================== 판매자 페이지 판매자정보 부분 끝 ====================================== -->

</div>
</div>

<script th:if="${insertSuccess != null}">
	showToast("[[${insertSuccess}]]","success");
</script>

<!-- ======================================= 탭 전환 + 상품 상태 스크립트 ====================================== -->
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="/js/comm/sweetalert.noah.js"></script>
<script th:inline="javascript">
/*<![CDATA[*/
document.addEventListener("DOMContentLoaded", function () {

    // ---------------- CSRF 토큰 ----------------
    const csrfToken = document.querySelector('meta[name="_csrf"]').content;
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

    const shopNo = /*[[${shop.shopNo}]]*/ 0;

    // ==================== 1. 탭 활성화 ====================
    const navLinks = document.querySelectorAll(".shop-header + nav a"); 
    const tabContents = document.querySelectorAll(".tab-content");
    const productArea = document.getElementById("product-area");

    function activateTab(tabName) {
        navLinks.forEach(l => l.classList.remove("active"));
        tabContents.forEach(c => c.classList.remove("active"));

        const link = document.querySelector(`.shop-header + nav a[data-tab="${tabName}"]`);
        const content = document.getElementById("tab-" + tabName);
        if (link) link.classList.add("active");
        if (content) content.classList.add("active");

        productArea.style.display = (tabName === "all") ? "block" : "none";

        // ✅ 전체 탭일 때만 상태 필터 보이기
        const statusFilter = document.getElementById('statusFilter');
        if (statusFilter) {
            statusFilter.style.display = (tabName === "all") ? "inline-block" : "none";
        }
    }

    const params = new URLSearchParams(window.location.search);
    const initialTab = params.get("tab") || "all";
    activateTab(initialTab);

    navLinks.forEach(link => {
        link.addEventListener("click", function(e) {
            e.preventDefault();
            activateTab(this.dataset.tab);
        });
    });

    // ==================== 2. 판매자 상품 상태 변경 ====================
    const statusSelects = document.querySelectorAll('.status-select');

    statusSelects.forEach(select => {
        select.addEventListener('change', function() {
            const productNo = this.dataset.productno;
            const newStatus = this.value;

            fetch(`/product/toggleStatusAjax/${productNo}?status=${newStatus}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken
                }
            })
            .then(response => {
                if(response.ok){
                    const card = select.closest('.product-card');
                    if(card){
                        const statusSpan = card.querySelector('span.status');
                        if(statusSpan){
                            statusSpan.textContent = newStatus == 0 ? '판매중' : '품절';
                            statusSpan.className = 'status ' + (newStatus == 0 ? 'selling' : 'soldout');
                        }
                    }
                    alert('상품 상태가 변경되었습니다.');
                } else {
                    alert('상태 변경 실패');
                }
            })
            .catch(err => {
                console.error(err);
                alert('오류가 발생했습니다.');
            });
        });
    });

    // ==================== 3. 상품 상태 필터 ====================
    const statusFilter = document.getElementById('statusFilter');
    const productContainers = document.querySelectorAll('#product-grid > div');

    function filterProducts() {
        const filter = statusFilter.value; // all, selling, soldout
        productContainers.forEach(container => {
            const card = container.querySelector('.product-card');
            if (!card) {
                container.style.display = (filter === 'all') ? 'block' : 'none';
                return;
            }
            const status = card.dataset.status;
            container.style.display = (filter === 'all' || status === filter) ? 'block' : 'none';
        });
    }

    filterProducts();
    statusFilter?.addEventListener('change', filterProducts);

    // ==================== 4. 월간 매출 그래프 ====================
    const monthlySales = /*[[${stats != null && stats.monthlySales != null ? stats.monthlySales : {0,0,0,0,0,0,0,0,0,0,0,0}}]]*/ [];
    const ctx = document.getElementById('shopStatsChart')?.getContext('2d');
    if(ctx){
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'],
                datasets: [{
                    label: '월간 매출',
                    data: monthlySales,
                    backgroundColor: '#FF6F0F',
                    hoverBackgroundColor: '#FF8F3F',
                    borderRadius: 12,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#FF6F0F',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        callbacks: {
                            label: function(context) {
                                return context.parsed.y.toLocaleString() + '원';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { color: '#333', font: { size: 14, weight: 'bold' } }
                    },
                    y: {
                        beginAtZero: true,
                        grid: { color: '#FFE5D1' },
                        ticks: {
                            callback: function(value) { return value.toLocaleString() + '원'; },
                            color: '#666',
                            font: { size: 13 }
                        }
                    }
                }
            }
        });
    }

    // ==================== 5. 주문 수락 / 거절 ====================
    function confirmAccept(btn) {
        const orderNo = btn.getAttribute('data-order-no');
        if(!confirm(`주문 #${orderNo}을 수락하시겠습니까?`)) return;

        fetch(`/shop/${orderNo}/accept`, { method: 'POST', headers: { [csrfHeader]: csrfToken } })
            .then(res => {
                if(res.ok){
                    alert('주문 수락 완료!');
                    const li = document.getElementById(`order-${orderNo}`);
                    if(li) li.remove();
                } else alert('수락 실패');
            });
    }

    function confirmReject(btn) {
        const orderNo = btn.getAttribute('data-order-no');
        if(!confirm(`주문 #${orderNo}을 거절하시겠습니까?`)) return;

        fetch(`/shop/${orderNo}/reject`, { method: 'POST', headers: { [csrfHeader]: csrfToken } })
            .then(res => {
                if(res.ok){
                    alert('주문 거절 완료!');
                    const li = document.getElementById(`order-${orderNo}`);
                    if(li) li.remove();
                } else alert('거절 실패');
            });
    }

    document.querySelectorAll('.btn-accept').forEach(btn => btn.addEventListener('click', () => confirmAccept(btn)));
    document.querySelectorAll('.btn-reject').forEach(btn => btn.addEventListener('click', () => confirmReject(btn)));

    // ==================== 6. 리뷰 답글 등록 ====================
    // 답글 작성 폼 토글
       document.querySelectorAll(".btn-toggle-comment").forEach(btn => {
           btn.addEventListener("click", function () {
               const reviewNo = this.dataset.reviewNo;
               const form = document.getElementById('comment-form-' + reviewNo);
               form.classList.toggle("hidden");
           });
       });

       // 댓글 등록 Ajax
       document.querySelectorAll(".btn-comment").forEach(btn => {
           btn.addEventListener("click", function () {
               const reviewNo = this.dataset.reviewNo;
               const textarea = document.getElementById('comment-' + reviewNo);
               const content = textarea.value.trim();
               if (!content) {
                   alert("댓글을 입력하세요.");
                   return;
               }

               fetch(`/shop/reviewPage/${shopNo}/review/${reviewNo}/comment`, {
                   method: "POST",
                   headers: {
                       "Content-Type": "application/x-www-form-urlencoded",
                       "X-CSRF-TOKEN": document.querySelector('meta[name="_csrf"]').content
                   },
                   body: new URLSearchParams({ content })
               })
               .then(res => res.text())
               .then(result => {
                   if (result === "success") location.reload();
                   else alert("댓글 등록 실패");
               });
           });
       });
   });
   
   //   ==========================정산 버튼 누를 시 (fetch 방식 유지) ===================================================
/*   document.getElementById("settleBtn").addEventListener("click", function(e){
       e.preventDefault();
       fetch("/center/settle/apply", {
           method: "POST",
           headers: {"Content-Type": "application/x-www-form-urlencoded"},
           body: "memberNo=[[${session.user.memberNo}]]"
       })
       .then(res => res.text())
       .then(data => {
           if(data === "success"){
               alert("정산이 완료되었습니다.");
               location.href = "/shop/shopmain";
           } else {
               alert("정산에 실패했습니다.");
           }
       });
   });
   
*/
	
	
	//정산 신청 버튼 클릭
    $("#settleApply").on("submit", function (e) {
        e.preventDefault(); // 기본 폼 전송 막기

        if (Swal.isVisible()) { // SweetAlert 열려있는지 체크
        Swal.close(); // 열려 있으면 닫기
    }
        let form = $(this);

        $.ajax({
            url: form.attr("action"),
            type: form.attr("method"),
            data: form.serialize(), // form 안에 있는 모든 input 전송
            success: function (response) {
                if (response === "success") {
                    showSuccessTitleAlert(" 정산 성공", "정산 신청이 완료되었습니다.", null);
                } else if (response === "fail") {
                    showWarningTitleAlert(" 정산 불가", "정산할 금액이 없습니다.", null);
                } else if (response === "zero") {
                    showWarningTitleAlert(" 정산 불가", "정산할 금액이 없습니다.", null);
                } else if (response === "error") {
                    showWarningTitleAlert(" 정산 불가", "정산할 금액이 없습니다.", null);
                } else {
                    showWarningTitleAlert(" 알 수 없는 응답", "서버에서 예상치 못한 응답을 보냈습니다.", null);
                }
            },
            error: function () {
                showErrorTitleAlert(" 서버 오류", "요청 처리 중 문제가 발생했습니다.", null);
            }
        });
    });


//정산 내역 보기

document.addEventListener("DOMContentLoaded", function() {
    const settleBtn = document.getElementById("settleBtn");
    const totalSalesEl = document.getElementById("totalSales");
    const settleForm = document.getElementById("settleForm");
    const settleInput = document.getElementById("settleAmountInput");

    if(settleBtn && totalSalesEl && settleForm && settleInput){
        settleForm.addEventListener("submit", function(e){
            e.preventDefault(); // 기본 제출 막기

            const totalSales = parseFloat(totalSalesEl.textContent || 0);
            const settleAmount = totalSales * 0.97; // 3% 차감
            settleInput.value = settleAmount.toFixed(0); // form에 값 넣기

            alert(`정산 금액: ${settleAmount.toLocaleString()}원`);

            settleForm.submit(); // 계산 후 form 제출
        });
    }
});

</script>

</div>
</body>
</html>
