<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/common/layout}">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/css/shop/shopview.css">

    <!-- CSRF í† í° -->
    <th:block layout:fragment="head-extra">
        <meta name="_csrf" th:content="${_csrf.token}">
        <meta name="_csrf_header" th:content="${_csrf.headerName}">
    </th:block>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
<div layout:fragment="content" class="container my-3">
    <div th:if="${shop != null}">
        <!-- ìƒì  í—¤ë” -->
        <div class="shop-header">
            <div class="shop-name" th:text="${shop.shopName}"></div>
        </div>

        <!-- ê³ ì • ì•Œë¦¼ì‚¬í•­ -->
        <div class="shopNotice"
             th:if="${pinnedNotice != null}"
             th:text="'ì•Œë¦¼ : [ì•ˆë‚´ì‚¬í•­] ' + ${pinnedNotice.shopNoticeTitle}">
        </div>

        <!-- íƒ­ -->
        <div class="tabs">
            <input type="radio" id="tab1" name="tab-group" checked>
            <label for="tab1">ì „ì²´ ìƒí’ˆ</label>
            <input type="radio" id="tab2" name="tab-group">
            <label for="tab2">ì•Œë¦¼ì‚¬í•­</label>
            <input type="radio" id="tab3" name="tab-group">
            <label for="tab3">ë¦¬ë·°</label>
            <input type="radio" id="tab4" name="tab-group">
            <label for="tab4">ë¬¸ì˜</label>
            <input type="radio" id="tab5" name="tab-group">
            <label for="tab5">ìƒì ì •ë³´</label>

            <!-- ì „ì²´ ìƒí’ˆ -->
            <div class="tab-content box" id="content1">
                <div id="product-grid">
                    <div th:if="${productList == null or #lists.isEmpty(productList)}"
                         class="text-center my-3">
                        ì•„ì§ ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.
                    </div>

                    <th:block th:each="product : ${productList}">
                        <div class="card m-2 product-card"
                             th:data-productno="${product.productNo}"
                             th:data-shopno="${product.shopNo}"
                             th:data-productname="${product.productName}"
                             th:data-price="${product.price}"
                             th:data-status="${product.status == 0 ? 'selling' : 'soldout'}"
                             th:data-seller-status="${product.shopStatus}">

                            <div class="image-wrapper">
                                <span th:if="${product.thumbnailName == null}">
                                    <img th:src="@{/upload/product/default.png}" />
                                </span>
                                <span th:unless="${product.thumbnailName == null}">
                                    <a class="linkDefault" th:href="@{|/product/detail/${product.productNo}|}">
                                        <img th:src="@{|/upload/product/${product.thumbnailName}|}" />
                                    </a>
                                </span>
                            </div>

                            <div class="card-body">
                                <button class="btn btn-light w-100 insertBtn" type="button">
                                    <img class="shoppingCartIcon" th:src="@{/image/main/add_shopping_cart.png}">&nbsp;ë‹´ê¸°
                                </button>

                                <a class="linkDefault" th:href=@{|/product/detail/${product.productNo}|}>
                                    <h6 class="card-subtitle mt-1" th:text="${product.shopName}"></h6>
                                    <h4 class="card-title" th:text="${product.productName}"></h4>
                                    <h6 th:text="${product.price}+'ì›'"></h6>
                                    <i class="bi bi-chat-left-dots"></i>
                                    <span th:text="${product.reviewCount}"></span>

                                    <th:block th:if="${product.isSubscription==1}">
                                        <span class="badge text-bg-warning w-25 text-center ms-1 p-1">ì •ê¸°ë°°ì†¡</span>
                                    </th:block>
                                </a>

                                <!-- ì°œ ë²„íŠ¼ -->
                                <i class="wish-btn position-absolute bottom-0 end-0 p-3"
                                   th:classappend="${product.isWished==1} ? 'bi-heart-fill' : 'bi-heart'"></i>
                            </div>
                        </div>
                    </th:block>
                </div>
            </div>

            <!-- ì•Œë¦¼ì‚¬í•­ -->
            <div class="tab-content box" id="content2">
                <h1>ì•Œë¦¼ì‚¬í•­</h1>

                <div th:if="${noticeList == null or #lists.isEmpty(noticeList)}"
                     class="text-center my-3" style="color:#888; font-size:14px;">
                    ì•Œë¦¼ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.
                </div>

                <ul th:if="${noticeList != null and !#lists.isEmpty(noticeList)}"
                    style="list-style:none; padding:0;">
                    <li th:each="notice : ${noticeList}" class="relative p-2 border rounded flex items-center gap-2 mb-2">
                        <a th:href="@{|/shop/noticeDetail/${notice.shopNoticeNo}|}"
                           class="flex-1 block p-2 hover:underline">
                            <p class="font-medium text-gray-800" th:text="${notice.shopNoticeTitle}"></p>
                            <p class="text-sm text-gray-500 mt-1"
                               th:text="${#dates.format(notice.createdAt, 'yyyy-MM-dd')}"></p>
                        </a>
                    </li>
                </ul>
            </div>

            <!-- ë¦¬ë·° -->
            <div class="tab-content box" id="content3">
                <h1>ë¦¬ë·°</h1>

                <div th:if="${reviewList == null or #lists.isEmpty(reviewList)}"
                     class="text-center my-3"
                     style="color:#888; font-size:16px;">
                    ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.
                </div>

                <div th:if="${reviewList != null and !#lists.isEmpty(reviewList)}">
                    <div th:each="review : ${reviewList}"
                         style="padding:12px 16px; border:1px solid #eee; border-radius:8px; margin-bottom:12px; background-color:#fff; box-shadow:0 1px 3px rgba(0,0,0,0.08); transition:all 0.2s ease-in-out;">
                        <a th:href="@{/product/detail/{productNo}(productNo=${review.productNo})}"
                           style="text-decoration:none; color:inherit; display:block;">
                            <p th:text="${review?.reviewContent}"
                               style="margin:0; font-size:14px; line-height:1.6; color:#333;">
                                ë¦¬ë·° ë‚´ìš© ì—†ìŒ
                            </p>
                        </a>
                    </div>
                </div>
            </div>

            <!-- ë¬¸ì˜ -->
            <div class="tab-content box" id="content4">
                <h1>ë¬¸ì˜</h1>

                <div th:if="${questionList == null or #lists.isEmpty(questionList)}"
                     class="text-center my-3"
                     style="color:#888; font-size:16px;">
                    ë¬¸ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.
                </div>

                <div th:if="${questionList != null and !#lists.isEmpty(questionList)}">
                    <div th:each="question : ${questionList}"
                         style="padding:12px 16px; border:1px solid #eee; border-radius:8px; margin-bottom:12px; background-color:#fff; box-shadow:0 1px 3px rgba(0,0,0,0.08);">
                        <p th:text="${question.content}" style="margin:0; font-size:14px; line-height:1.6; color:#333;">
                            ë¬¸ì˜ ë‚´ìš© ì—†ìŒ
                        </p>
                    </div>
                </div>
            </div>

            <!-- ìƒì ì •ë³´ -->
            <div class="tab-content shop-info-card box" id="content5">
                <h1 style="text-align: left; border-bottom: 2px solid #ddd; padding-bottom: 20px; margin-bottom: 25px;">
                    ìƒì  ì •ë³´
                </h1>

                <!-- ê°€ê²Œ ì´ë¦„ / ì‚¬ì—…ìë²ˆí˜¸ -->
                <div style="display: flex; gap: 20px; margin-bottom: 20px; align-items: flex-start;">
                    <div class="shop-info-row" style="flex:1;">
                        <span>ğŸª</span>
                        <div>
                            <div style="font-weight:600; color:#555; margin-bottom:6px;">ê°€ê²Œ ì´ë¦„</div>
                            <div style="font-size:16px; color:#222;" th:text="${shop.shopName}">ê°€ê²Œ ì´ë¦„</div>
                        </div>
                    </div>

                    <div class="shop-info-row" style="flex:1;">
                        <span>ğŸ†”</span>
                        <div>
                            <div style="font-weight:600; color:#555; margin-bottom:6px;">ì‚¬ì—…ìë²ˆí˜¸</div>
                            <div style="font-size:16px; color:#222;" th:text="${shop.tinNo}">123-45-67890</div>
                        </div>
                    </div>
                </div>
                <hr>

                <!-- ì£¼ì†Œ -->
                <div class="shop-info-row">
                    <span>ğŸ“</span>
                    <div>
                        <div style="font-weight:600; color:#555; margin-bottom:6px;">ì£¼ì†Œ</div>
                        <div style="font-size:16px; color:#222;" th:text="${shop.shopAddress}">ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ ì˜ˆì‹œë¡œ 123</div>
                    </div>
                </div>
                <hr>

                <!-- ê°€ê²Œ ì—°ë½ì²˜ -->
                <div class="shop-info-row">
                    <span>ğŸ“</span>
                    <div>
                        <div style="font-weight:600; color:#555; margin-bottom:6px;">ê°€ê²Œ ì—°ë½ì²˜</div>
                        <div style="font-size:16px; color:#222;" th:text="${shop.shopContact}">010-1234-5678</div>
                    </div>
                </div>
                <hr>

                <!-- ì˜ì—…ì‹œê°„ -->
                <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                    <div class="shop-info-row" style="flex:1;">
                        <span>â°</span>
                        <div>
                            <div style="font-weight:600; color:#555; margin-bottom:6px;">ì˜ì—… ì˜¤í”ˆì‹œê°„</div>
                            <div style="font-size:16px; color:#222;" th:text="${shop.openTime}">09:00</div>
                        </div>
                    </div>
                    <div class="shop-info-row" style="flex:1;">
                        <span>â°</span>
                        <div>
                            <div style="font-weight:600; color:#555; margin-bottom:6px;">ì˜ì—… ë§ˆê°ì‹œê°„</div>
                            <div style="font-size:16px; color:#222;" th:text="${shop.closeTime}">21:00</div>
                        </div>
                    </div>
                </div>
                <hr>

                <!-- ìƒì  ì†Œê°œ -->
                <div class="shop-info-row">
                    <span>ğŸ’¬</span>
                    <div>
                        <div style="font-weight:600; color:#555; margin-bottom:6px;">ìƒì  ì†Œê°œ</div>
                        <div style="font-size:16px; color:#222; white-space: pre-wrap;" th:text="${shop.shopInfo}">ìƒì  ì†Œê°œ ë‚´ìš©</div>
                    </div>
                </div>
                <hr>

                <!-- ë°°ë‹¬ë¹„ -->
                <div class="shop-info-row" style="margin-bottom:0;">
                    <span>ğŸšš</span>
                    <div>
                        <div style="font-weight:600; color:#555; margin-bottom:6px;">ê°€ê²Œ ë°°ë‹¬ë¹„</div>
                        <div style="font-size:16px; color:#222;" th:text="${shop.deliveryFee}">3,000ì›</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script layout:fragment="script" th:inline="javascript">

$(function () {
    const memberNo = /*[[${memberNo}]]*/ 'null';
    const isLogin = memberNo !== 'null';

    const token = $('meta[name="_csrf"]').attr('content');
    const header = $('meta[name="_csrf_header"]').attr('content');
    $(document).ajaxSend(function(e, xhr) {
        if(token && header) xhr.setRequestHeader(header, token);
    });

    // ì œì¬ íŒë§¤ì êµ¬ë§¤ ë§‰ê¸°
    $('.product-card').each(function() {
        console.log($(this).data('seller-status'), typeof $(this).data('seller-status'));
        const sellerStatus = parseInt($(this).data('seller-status'), 10);
        if (sellerStatus === 1) {
            $(this).find('.insertBtn').prop('disabled', true).css({
                'background-color': '#ccc',
                'cursor': 'not-allowed'
            });
            if ($(this).find('.notice').length === 0) {
                $(this).append('<div class="notice" style="color:red; margin-top:5px;">ì œì¬ íŒë§¤ìì˜ ìƒí’ˆì€ êµ¬ë§¤í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>');
            }
        }
    });

    // ì°œ ë²„íŠ¼
    $(document).on('click', '.wish-btn', function(){
        if(!isLogin){
            Swal.fire({
                icon: 'warning',
                title: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.',
                confirmButtonText: 'í™•ì¸'
            }).then(()=> { window.location.href='/member/login'; });
            return;
        }

        const $card = $(this).closest('.product-card');
        const sellerStatus = $card.data('seller-status');
        if(sellerStatus === 1){
            Swal.fire({
                icon: 'error',
                title: 'ì´ ìƒí’ˆì€ íŒë§¤ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.',
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 1500
            });
            return;
        }

        const productNo = $card.data('productno');
        const $btn = $(this);

        $.ajax({
            url:'/product/wish/toggle',
            method:'POST',
            contentType:'application/json',
            data: JSON.stringify({productNo}),
            success: function(res){
                const wished = !!res.wished;
                $btn.removeClass('bi-heart bi-heart-fill').addClass(wished?'bi-heart-fill':'bi-heart');

                Swal.fire({
                    icon: 'success',
                    title: wished ? 'ì°œí–ˆìŠµë‹ˆë‹¤.' : 'ì°œì„ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 1500
                });
            },
            error: function(xhr){
                Swal.fire({
                    icon:'error',
                    title:'ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton:false,
                    timer:1500
                });
            }
        });
    });

    // ë‹´ê¸° ë²„íŠ¼
    $(document).on('click', '.insertBtn', function(){
        if(!isLogin){
            Swal.fire({
                icon:'warning',
                title:'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.',
                confirmButtonText:'í™•ì¸'
            }).then(()=> { window.location.href='/member/login'; });
            return;
        }

        const $card = $(this).closest('.product-card');
        const sellerStatus = $card.data('seller-status');
        if(sellerStatus === 1){
            Swal.fire({
                icon: 'error',
                title: 'ì´ ìƒí’ˆì€ íŒë§¤ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.',
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 1500
            });
            return;
        }

        const productNo   = $card.data('productno');
        const shopNo      = $card.find('[data-shopno]').data('shopno');
        const productName = $card.find('[data-productname]').data('productname');
        const price       = $card.find('[data-price]').data('price');
        const quantity    = 1;

        $.ajax({
            url:'/order/cartInsert',
            method:'POST',
            contentType:'application/json',
            data: JSON.stringify({productNo, shopNo, productName, price, quantity, memberNo}),
            success:function(){
                Swal.fire({
                    icon:'success',
                    title:'ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton:false,
                    timer:1500
                });
            },
            error:function(xhr){
                Swal.fire({
                    icon:'error',
                    title:'ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton:false,
                    timer:1500
                });
            }
        });
    });
});
</script>
</body>
</html>
