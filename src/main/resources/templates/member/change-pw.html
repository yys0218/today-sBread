<!-- 임시 비밀번호로 로그인 후 비밀번호 변경 페이지 -->
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/member/change-pw.css}">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

<div class="change-pw-box">
    <h3 class="text-center mb-4">비밀번호 변경</h3>

    <form id="changePwForm">
        <!-- 새 비밀번호 -->
        <div class="mb-3">
            <label for="newPw" class="form-label">새 비밀번호</label>
            <input type="password" class="form-control" id="newPw" name="newPw" required>
        </div>

        <!-- 새 비밀번호 확인 -->
        <div class="mb-3">
            <label for="confirmPw" class="form-label">새 비밀번호 확인</label>
            <input type="password" class="form-control" id="confirmPw" name="confirmPw" required>
        </div>

        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-submit flex-fill">비밀번호 변경</button>
            <button type="button" class="btn btn-secondary flex-fill" onclick="window.location.href='/member/login'">취소</button>
        </div>
    </form>
    <div id="result" class="text-center"></div>
</div>

<script>
// CSRF 토큰과 헤더 값 가져오기
const token = $("meta[name='_csrf']").attr("content");			
const header = $("meta[name='_csrf_header']").attr("content");

// 실시간 비밀번호 일치 확인
$("#newPw, #confirmPw").on("input", function() {
	// 입력된 새 비밀번호와 확인 비밀번호 값 가져옴
    const newPw = $("#newPw").val().trim();
    const confirmPw = $("#confirmPw").val().trim();
    
    // 둘 다 입력되지 않았다면 결과창을 비우고 종료
    if(!newPw && !confirmPw){
        $("#result").html("");	// 결과 영역 초기화
        return;
    }
    
    // 두 입력값이 같으면 "일치"라고 표시
    if(newPw === confirmPw){
        $("#result").addClass("text-success").removeClass("text-danger").html("비밀번호가 일치합니다.");
    } else {	// 다르면 일치하지 않음 표시
        $("#result").addClass("text-danger").removeClass("text-success").html("비밀번호가 일치하지 않습니다.");
    }
});

// 폼 제출 이벤트 처리
$("#changePwForm").submit(function(e){
    e.preventDefault();		// 기본 폼 제출 막기

    // 입력값 가져오기
    const data = {
        newPw: $("#newPw").val().trim(),		// 새 비밀번호
        confirmPw: $("#confirmPw").val().trim()	// 새 비밀번호 확인
    };

    // 값이 하나라도 비어 있으면 오류 메시지 표시
    if(!data.newPw || !data.confirmPw){
        $("#result").addClass("text-danger").removeClass("text-success").html("모든 항목을 입력해주세요.");
        return;
    }

    // 새 비밀번호와 확인 비밀번호가 다르면 오류 메시지 표시
    if(data.newPw !== data.confirmPw){
        $("#result").addClass("text-danger").removeClass("text-success").html("새 비밀번호가 일치하지 않습니다.");
        return;
    }

    // 비밀번호 변경 AJAX
    // 요청 방식 : post
    // URL : /member/change-pw
    $.ajax({
        type: "POST",
        url: "/member/change-pw",
        contentType: "application/json",	// JS객체 -> JSON 문자열로 변환
        data: JSON.stringify(data),
        beforeSend: function(xhr){
        	// 요청 보내기 전 CSRF 보안 헤더를 같이 보냄
            xhr.setRequestHeader(header, token);
        },
        success: function(res){
        	// 서버 응답에서 success 값이 true라면 성공
            if(res.success){
                $("#result").addClass("text-success").removeClass("text-danger").html(
                    "비밀번호가 성공적으로 변경되었습니다. <br>5초 후 메인 화면으로 이동합니다."
                );
                setTimeout(() => { window.location.href = '/'; }, 5000); // 5초 후 이동
            // success = false일 경우 서버에서 온 에러 메시지 출력
            } else {
                $("#result").addClass("text-danger").removeClass("text-success").html(res.message);
            }
        },
        error: function(){
        	// 서버 오류나 네트워크 문제 발생 시 메시지 표시
            $("#result").addClass("text-danger").removeClass("text-success").html("서버 요청 중 오류가 발생했습니다.");
        }
    });
});
</script>
</body>
</html>