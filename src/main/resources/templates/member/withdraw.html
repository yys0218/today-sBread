<!-- templates/member/withdraw.html -->
<!-- 회원탈퇴 페이지 -->
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" lang="ko" layout:decorate="~{common/layout}">
<head>
  	<link rel="stylesheet" th:href="@{/css/member/withdraw.css}">
  	<script th:src="@{/js/comm/sweetalert.noah.js}"></script>
</head>

<body>
	<div layout:fragment="content" class="container my-3">
  		<div class="main-wrapper">
    		<!-- 좌측 사이드바는 공통 레이아웃에 있고, 여기선 오른쪽만 렌더 -->
    		<div class="content-area">
      			<form class="withdraw-wrap" th:action="@{/member/withdraw}" method="post" id="withdrawForm">
        			<!-- CSRF / 회원 식별 -->
        			<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
        			<input type="hidden" name="memberId" th:value="${memberId}">
	
        			<h2>회원 탈퇴</h2>
        			<p class="desc">탈퇴하시기 전에 아래 항목을 확인해 주세요.</p>

        			<!-- 탈퇴 사유 (단일 선택: 라디오) -->
        			<section class="section">
          				<h3 class="section-title">탈퇴 사유</h3>
          					<ul class="radios">
            					<li>
              						<label>
                						<input type="radio" name="reason" value="서비스 이용이 불편함"
                    						   th:checked="${selectedReason == '서비스 이용이 불편함'}">
                							서비스 이용이 불편함
              						</label>
            					</li>
            					<li>
              						<label>
                						<input type="radio" name="reason" value="원하는 제품/빵집이 없음"
                       						   th:checked="${selectedReason == '원하는 제품/빵집이 없음'}">
                							원하는 제품/빵집이 없음
              						</label>
            					</li>
            					<li>
              						<label>
                						<input type="radio" name="reason" value="가격/혜택 불만"
                       						   th:checked="${selectedReason == '가격/혜택 불만'}">
                							가격/혜택 불만
              						</label>
            					</li>
            					<li>
              						<label>
                						<input type="radio" name="reason" value="앱/웹 오류 잦음"
                       						   th:checked="${selectedReason == '앱/웹 오류 잦음'}">
                							앱/웹 오류 잦음
              						</label>
            					</li>
            					<li>
              						<label>
                						<input type="radio" name="reason" value="배송/포장 불만"
                     						   th:checked="${selectedReason == '배송/포장 불만'}">
                							배송/포장 불만
              						</label>
            					</li>
            					<li>
              						<label>
                						<input type="radio" id="reasonOther" name="reason" value="기타"
                    						   th:checked="${selectedReason == '기타'}">
                							기타
              						</label>
						            <!-- 처음엔 무조건 숨김: display:none + hidden -->
						            <textarea id="otherText" name="otherReason" class="other-text" rows="3"
						                      placeholder="기타 사유를 입력하세요."
						                      th:text="${otherReason}"
						                      style="display:none;" hidden>
						            </textarea>
            					</li>
          					</ul>
       	 				</section>

        				<!-- 유의사항 + 동의 -->
        				<section class="section">
          					<h3 class="section-title">탈퇴 시 유의사항</h3>
          						<div class="terms">
            						<p>• 탈퇴 시 주문/후기/문의 등 회원 정보는 관련 법령에 따라 보관 또는 즉시 삭제됩니다.</p>
            						<p>• 정기 결제가 설정된 경우 먼저 해지 후 탈퇴해 주세요.</p>
            						<p>• 탈퇴 후 동일 아이디 재사용은 제한될 수 있습니다.</p>
          						</div>
          						<label class="agree">
            						<input type="checkbox" id="agree" name="agree" th:checked="${agreeChecked}">
            							위 내용을 모두 확인했으며 탈퇴에 동의합니다.
          						</label>
        				</section>

        				<!-- 메시지 영역 -->
        				<p class="msg error"
           				   th:text="${(withdrawError != null and !#strings.isEmpty(withdrawError)) ? withdrawError : error}"></p>
        				<p class="msg ok" th:text="${message}"></p>

        				<!-- 버튼 -->
        				<div class="btn-row">
          					<a th:href="@{/member/account-info}" class="btn btn-ghost">취소</a>
          					<button type="submit" class="btn btn-danger" id="doWithdraw">회원 탈퇴</button>
        				</div>
      				</form>

			<script th:inline="javascript">
			  	(function waitForjQuery(){
			    	if (window.jQuery) initWithdrawScript();
			    	else setTimeout(waitForjQuery, 40);
			  	})();
			
			  	function initWithdrawScript(){
			    	$(function () {
			
			      	// 요소 캐싱
			      	const $form      = $('#withdrawForm');
			      	const $otherText = $('#otherText');   // 기타 사유 textarea
			      	const $agree     = $('#agree');
			      	const $submitBtn = $('#doWithdraw');
			
			      	if ($form.length === 0) return;
			
			      	// 현재 선택된 라디오 값
			      	function getSelectedReason() {
			        	return $('input[name="reason"]:checked').val(); // 없으면 undefined
			      	}
			
			      	// 제출 가능 여부
			      	function canSubmitNow() {
			        	const reason   = getSelectedReason();
			        	const isOther  = (reason === '기타');
			        	const hasOther = !isOther || ($.trim($otherText.val()).length > 0);
			        	const agreed   = $agree.prop('checked');
			        	return !!reason && hasOther && agreed;
			      	}
			
			      	// 초기 상태: 무조건 숨김 + required 해제(사용자 요청: 클릭 전엔 보이지 않게)
			      	$otherText.hide().attr('hidden', 'hidden').prop('required', false);
			      	$submitBtn.prop('disabled', !canSubmitNow());
			
			      	$(document).on('input', 'input:radio[name=reason]', function () {
			        	//    if($("input:radio[name='radioButton']").attr("checked"))
			        	console.log($("input:radio[id='reasonOther']").prop('checked'));
			        	if ($("input:radio[id='reasonOther']").prop('checked')) {
			        		  $('#otherText').show().removeAttr('hidden').prop('required', true);
			        	} else {
			          		$('#otherText').hide().attr('hidden', 'hidden').prop('required', false);
			        	}
			        	// 버튼 상태 갱신
			        	$submitBtn.prop('disabled', !canSubmitNow());
			      	});
			
			      	// textarea/동의 체크 변화 시 버튼 상태만 갱신
			      	$form.on('input change', function () {
			        	$submitBtn.prop('disabled', !canSubmitNow());
			      	});
			
			      	// 제출 시 간단 유효성 가드
			      	$form.on('submit', function(e){
			        	if (!canSubmitNow()) {
			          		e.preventDefault();
			          		const reason = getSelectedReason();
			          		if (!reason) { showInfoAlert('탈퇴 사유를 선택해주세요.'); return; }
			          		if (reason === '기타' && !$.trim($otherText.val())) { showInfoAlert('기타 사유를 입력해주세요.'); return; }
			          		if (!$agree.prop('checked')) { showWarningAlert('탈퇴 시 유의사항에 동의해야 합니다.'); return; }
			        	}
			      	});
			    });
			  }
				<!-- 스윗알럿 헬퍼가 준비되면 실행 -->
				(function waitForSwal(){
					if (typeof showSuccessAlert === 'function') {
			  			try {
			  	        	var params = new URLSearchParams(window.location.search);
			  	        	if (params.get('withdraw') === '1') {
			  	          		// 탈퇴 완료 알림
			  	          		showSuccessAlert('회원 탈퇴가 완료되었습니다. 그동안 이용해주셔서 감사합니다.');
			  	          		// 주소창 정리 (뒤로가기/새로고침 시 다시 뜨지 않도록)
			  	          		var clean = window.location.origin + window.location.pathname + window.location.hash;
			  	          		history.replaceState({}, document.title, clean);
			  	        	}
			  	      	} catch (e) { /* no-op */ }
			  	    } else {
			  	      	setTimeout(waitForSwal, 40);
			  	    }
				})();
			</script>
		<div>
	</div>
</div>
</body>
</html>