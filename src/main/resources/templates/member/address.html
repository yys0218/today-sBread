<!-- 스윗얼랏 적용 완료 -->
<!-- 마이페이지 - 배송지 관리 -->
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" lang="ko"
	layout:decorate="~{common/layout}">
<head>
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<meta name="_csrf" th:content="${_csrf?.token}" />
<meta name="_csrf_header" th:content="${_csrf?.headerName}" />
<link rel="stylesheet" th:href="@{/css/member/mypage.css}">
<link rel="stylesheet" th:href="@{/css/member/address.css}">
<script th:src="@{/js/comm/sweetalert.noah.js}"></script>

<style>
/* 버튼 클릭이 라디오/라벨에 가려지는 이슈 방지 */
.addr-item .addr-footer .btn {
	position: relative;
	z-index: 3;
	pointer-events: auto;
}

.addr-item .default-ctrl label {
	pointer-events: auto;
}
</style>
</head>

<body>
	<div layout:fragment="content" class="container my-3 mypage">
		<div class="main-wrapper">

			<!-- 왼쪽 사이드바 -->
			<div class="sidebar">
				<ul>
					<li><a class="mypage-title" th:href="@{/member/mypage}">마이페이지</a></li>
					<li><a th:href="@{/member/order-list}">주문 내역</a></li>
					<li><a th:href="@{/member/wish-list}">찜 목록</a></li>
					<li><a th:href="@{/member/subscription}">정기 결제 조회/해지</a></li>
					<li><a th:href="@{/member/review-list}">상품 후기</a></li>
					<li><a th:href="@{/member/address}" class="is-active"
						aria-current="page">배송지 관리</a></li>
					<li><a th:href="@{/member/account-info}">회원 정보 관리</a></li>
					<li><a th:href="@{/center}">고객 센터</a></li>
					<li><a th:href="@{/center/report/list}">신고 내역</a></li>
					<li><a th:href="@{/center/inquiry/list}">문의 내역</a></li>
				</ul>
			</div>

			<!-- 오른쪽: 주소 리스트 + 기본 배송지 설정 + 추가 -->
			<div class="content-right">
				<h2 class="address-title">배송지 관리</h2>
				<div id="content-area" class="content-area">
					<div class="addr-section">

						<!-- 목록/폼: 서버에서 addresses가 존재할 때 -->
						<div th:if="${addresses != null and !#lists.isEmpty(addresses)}">
							<form id="defaultForm" th:action="@{/member/address/set-default}"
								method="post">
								<input type="hidden" th:name="${_csrf.parameterName}"
									th:value="${_csrf.token}" />
								<div class="addr-list" id="addrList">
									<div class="addr-item" th:each="addr : ${addresses}"
										th:attr="data-address-no=${addr.addressNo}">
										<div class="addr-header">
											<span class="addr-name" th:text="${addr.receiverName}">수령인</span>
											<span class="badge-chip badge-primary"
												th:if="${addr.isDefault == 'Y'}">기본배송지</span>
										</div>
										<div class="addr-body">
											<div class="row-line" th:text="${addr.addressDetail}">서울특별시
												…</div>
											<div class="row-line" th:text="${addr.receiverPhone}">010-0000-0000</div>
										</div>
										<div class="addr-footer">
											<button type="button"
												class="addr-edit-btn btn btn-outline-secondary btn-sm"
												th:attr="data-no=${addr.addressNo},
                                     data-name=${addr.receiverName},
                                     data-phone=${addr.receiverPhone},
                                     data-detail=${addr.addressDetail},
                                     data-default=${addr.isDefault}">
												수정</button>
											<button type="button"
												class="addr-delete-btn btn btn-outline-danger btn-sm"
												th:attr="data-no=${addr.addressNo}">삭제</button>
											<div class="default-ctrl">
												<input type="radio" name="addressNo"
													th:value="${addr.addressNo}"
													th:checked="${addr.isDefault == 'Y'}"
													th:id="${'addrDefault__' + addr.addressNo}" /> <label
													th:for="${'addrDefault__' + addr.addressNo}">기본 배송지</label>
											</div>
										</div>
									</div>
								</div>

								<div class="default-save-wrap">
									<div class="default-actions">
										<button type="submit" class="btn btn-dark" id="btnDefaultSave">기본
											배송지 저장</button>
										<button type="button" class="btn btn-addr-add"
											id="addrAddTrigger" aria-label="배송지 추가"
											>
											+ 배송지 추가</button>
									</div>
									<div class="addr-help" id="addrAddHelp">최대 5개까지 등록할 수
										있어요.</div>
								</div>
							</form>
						</div>

						<!-- 빈 상태: 서버에서 addresses가 비었을 때 -->
						<div th:if="${addresses == null or #lists.isEmpty(addresses)}"
							class="addr-empty" id="addrEmpty">
							등록된 배송지가 없습니다.
							<div class="addr-add-wrap"
								style="border-top: 0; margin-top: 12px;">
								<button type="button" class="btn addr-cta" id="addrAddTrigger"
									data-bs-toggle="modal" data-bs-target="#addressAddModal">+
									배송지 추가</button>
								<div class="addr-help" id="addrAddHelp">최대 5개까지 등록할 수 있어요.</div>
							</div>
						</div>

					</div>

					<!-- 모달: 추가 -->
					<div class="modal fade" id="addressAddModal" tabindex="-1"
						aria-labelledby="addressAddModalLabel" aria-hidden="true">
						<div class="modal-dialog modal-dialog-centered">
							<div class="modal-content">
								<div class="modal-header">
									<h5 class="modal-title" id="addressAddModalLabel">배송지 추가</h5>
									<button type="button" class="btn-close" data-bs-dismiss="modal"
										aria-label="닫기"></button>
								</div>
								<div class="modal-body">
									<form id="addrAddForm">
										<div class="mb-2">
											<label class="form-label">받는 사람</label> <input type="text"
												name="receiverName" class="form-control" placeholder="받는 사람"
												required />
										</div>
										<div class="mb-2">
											<label class="form-label">주소</label>
											<div class="input-group">
												<input type="text" id="addrMain" class="form-control"
													placeholder="우편번호/도로명 찾기" readonly required />
												<button type="button" class="btn btn-outline-primary"
													id="btnFindAddrAdd">찾기</button>
											</div>
											<input type="hidden" name="address1" id="address1" /> <input
												type="hidden" name="postcode" id="postcode" />
										</div>
										<div class="mb-2">
											<label class="form-label">상세주소</label> <input type="text"
												id="addrDetail" name="address2" class="form-control"
												placeholder="상세주소 (선택)" />
										</div>
										<div class="mb-2">
											<label class="form-label">휴대폰</label> <input type="text"
												name="receiverPhone" class="form-control" maxlength="13"
												placeholder="010-1234-5678"
												oninput="this.value=this.value.replace(/[^0-9-]/g,'')"
												required />
										</div>
										<div class="form-check mb-2">
											<input class="form-check-input" type="checkbox"
												id="isDefault" name="isDefault" value="Y" /> <label
												class="form-check-label" for="isDefault">기본 배송지로 선택</label>
										</div>
										<input type="hidden" name="addressDetail"
											id="addressDetailHidden" />
									</form>
								</div>
								<div class="modal-footer">
									<button type="button" class="btn btn-outline-secondary"
										data-bs-dismiss="modal">취소</button>
									<button type="button" class="btn btn-primary" id="btnSaveAdd">저장</button>
								</div>
							</div>
						</div>
					</div>

					<!-- 모달: 수정 -->
					<div class="modal fade" id="addressEditModal" tabindex="-1"
						aria-labelledby="addressEditModalLabel" aria-hidden="true">
						<div class="modal-dialog modal-dialog-centered">
							<div class="modal-content">
								<div class="modal-header">
									<h5 class="modal-title" id="addressEditModalLabel">배송지 수정</h5>
									<button type="button" class="btn-close" data-bs-dismiss="modal"
										aria-label="닫기"></button>
								</div>
								<div class="modal-body">
									<form id="addrEditForm">
										<input type="hidden" name="addressNo" id="editAddressNo" /> <input
											type="hidden" name="addressDetail"
											id="addressDetailHiddenEdit" />
										<div class="mb-2">
											<label class="form-label">받는 사람</label> <input type="text"
												name="receiverName" id="receiverNameEdit"
												class="form-control" placeholder="받는 사람" required />
										</div>
										<div class="mb-2">
											<label class="form-label">주소</label>
											<div class="input-group">
												<input type="text" id="addrMainEdit" class="form-control"
													placeholder="우편번호/도로명 찾기" readonly required />
												<button type="button" class="btn btn-outline-primary"
													id="btnFindAddrEdit">찾기</button>
											</div>
											<input type="hidden" name="address1" id="address1Edit" /> <input
												type="hidden" name="postcode" id="postcodeEdit" />
										</div>
										<div class="mb-2">
											<label class="form-label">상세주소</label> <input type="text"
												id="addrDetailEdit" name="address2" class="form-control"
												placeholder="상세주소 (선택)" />
										</div>
										<div class="mb-2">
											<label class="form-label">휴대폰</label> <input type="text"
												name="receiverPhone" id="receiverPhoneEdit"
												class="form-control" maxlength="13"
												placeholder="010-1234-5678"
												oninput="this.value=this.value.replace(/[^0-9-]/g,'')"
												required />
										</div>
										<div class="form-check mb-2">
											<input class="form-check-input" type="checkbox"
												id="isDefaultEdit" name="isDefault" value="Y" /> <label
												class="form-check-label" for="isDefaultEdit">기본 배송지로
												설정</label>
										</div>
									</form>
								</div>
								<div class="modal-footer">
									<button type="button" class="btn btn-outline-secondary"
										data-bs-dismiss="modal">취소</button>
									<button type="button" class="btn btn-primary" id="btnSaveEdit">저장</button>
								</div>
							</div>
						</div>
					</div>

				</div>
				<!-- /content-area -->
				<!-- 라이브러리 -->
				<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
				<script
					src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
				<script
					src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"
					id="daum-postcode-sdk"></script>

				<script>
(function () {
  const MAX_ADDR = 5;
  const $id = id => document.getElementById(id);
  const addModalEl  = document.getElementById('addressAddModal');
  const editModalEl = document.getElementById('addressEditModal');
  const addModal    = addModalEl ? new bootstrap.Modal(addModalEl) : null;
  const editModal   = editModalEl ? new bootstrap.Modal(editModalEl) : null;
  
  function getAddrCount() {
    return document.querySelectorAll('#addrList .addr-item').length;
  }

  function updateAddButtonState() {
    const addBtn = $id('addrAddTrigger');
    const help   = $id('addrAddHelp');
    if (!addBtn) return;
    const cnt = getAddrCount();
    if (cnt >= MAX_ADDR) {
      addBtn.disabled = true;
      addBtn.textContent = `배송지 5/5 (추가 불가)`;
      addBtn.setAttribute('aria-disabled', 'true');
      if (help) help.textContent = '더 이상 추가할 수 없습니다.';
    } else {
      addBtn.disabled = false;
      addBtn.removeAttribute('aria-disabled');
      addBtn.textContent = `+ 배송지 추가 (${cnt}/${MAX_ADDR})`;
      if (help) help.textContent = '최대 5개까지 등록할 수 있어요.';
    }
  }

  function showSoftBanner(msg) {
    const area = $id('content-area');
    if (!area) return;
    const banner = document.createElement('div');
    banner.className = 'soft-banner';
    banner.textContent = msg;
    area.prepend(banner);
    setTimeout(() => banner.remove(), 3500);
  }

  function csrfHeaders() {
    const token  = document.querySelector('meta[name="_csrf"]')?.getAttribute('content') || '';
    const header = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content') || '';
    const h = { 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8' };
    if (token && header) h[header] = token;
    return h;
  }

  // 주소 팝업 공통
  function openDaumPostcodeInto(targets) {
    const { addrMainId, address1Id, postcodeId, addrDetailId } = targets || {};
    function run() {
      if (!(window.daum && daum.Postcode)) {
        showErrorAlert('주소 검색 스크립트를 불러오지 못했습니다.');
        return;
      }
      new daum.Postcode({
        oncomplete: function (data) {
          const base = data.roadAddress || data.jibunAddress || data.autoRoadAddress || data.autoJibunAddress || '';
          const addrMain   = $id(addrMainId);
          const address1   = $id(address1Id);
          const postcode   = $id(postcodeId);
          const addrDetail = $id(addrDetailId);
          if (addrMain)   addrMain.value = base;
          if (address1)   address1.value = base;
          if (postcode)   postcode.value = data.zonecode || '';
          if (addrDetail) addrDetail.focus();
        }
      }).open();
    }
    if (window.daum && daum.Postcode) return run();
    const s = document.getElementById('daum-postcode-sdk');
    if (s) { s.addEventListener('load', run, { once: true }); }
    else   { showErrorAlert('주소 검색 스크립트를 로드하지 못했습니다.'); }
  }

  function execDaumPostcodeModal() {
    openDaumPostcodeInto({
      addrMainId: 'addrMain',
      address1Id: 'address1',
      postcodeId: 'postcode',
      addrDetailId: 'addrDetail'
    });
  }
  function execDaumPostcodeModalEdit() {
    openDaumPostcodeInto({
      addrMainId: 'addrMainEdit',
      address1Id: 'address1Edit',
      postcodeId: 'postcodeEdit',
      addrDetailId: 'addrDetailEdit'
    });
  }

  // 추가 저장
  async function saveAddressFromModal(btn) {
    try {
      const form   = $id('addrAddForm');
      const main   = ($id('addrMain').value || '').trim();
      const detail = ($id('addrDetail').value || '').trim();
      const name   = form.querySelector('input[name="receiverName"]').value.trim();
      const phone  = form.querySelector('input[name="receiverPhone"]').value.trim();

      if (getAddrCount() >= MAX_ADDR) { showInfoAlert('배송지는 최대 5개까지 등록할 수 있습니다.'); return; }
      $id('addressDetailHidden').value = main + (detail ? ' ' + detail : '');
      if (!form.checkValidity()) { form.reportValidity(); return; }
      if (!main) { showInfoAlert('우편번호 찾기로 주소를 선택해주세요.'); return; }
      if (btn) { btn.disabled = true; btn.textContent = '저장 중…'; }

      const bodyData = new URLSearchParams(new FormData(form)).toString();
      if (window.jQuery) {
        await new Promise((res, rej) => $.ajax({
          url: '/member/address/add', method: 'POST', data: bodyData,
          contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
          beforeSend: xhr => { const h = csrfHeaders(); for (const k in h) xhr.setRequestHeader(k, h[k]); },
          success: res, error: rej
        }));
      } else {
        const r = await fetch('/member/address/add', { method: 'POST', headers: csrfHeaders(), body: bodyData });
        if (!r.ok) { const e = new Error('save failed'); e.status = r.status; throw e; }
      }
   // 모달 닫기 (Backdrop/잠금까지 안전하게 정리)
      const modalEl = $id('addressAddModal');
      const modal = bootstrap.Modal.getInstance(modalEl) 
                   || bootstrap.Modal.getOrCreateInstance(modalEl);

      if (modal) {
        modal.hide();
      }


      // 최초 비어있던 경우 틀 생성
      let listEl = $id('addrList');
      const emptyEl = $id('addrEmpty');
      if (!listEl) {
        const contentArea = $id('content-area');
        contentArea.innerHTML = `
          <div class="addr-section">
            <form id="defaultForm" action="/member/address/set-default" method="post">
              <div class="addr-list" id="addrList"></div>
              <div class="default-save-wrap">
                <button type="submit" class="btn btn-dark" id="btnDefaultSave">기본 배송지 저장</button>
              </div>
            </form>
            <div class="addr-add-wrap" id="addrAddWrap">
              <button type="button" class="btn addr-cta" id="addrAddTrigger" data-bs-toggle="modal" data-bs-target="#addressAddModal">+ 배송지 추가</button>
              <div class="addr-help" id="addrAddHelp">최대 5개까지 등록할 수 있어요.</div>
            </div>
          </div>`;
        listEl = $id('addrList');
        // defaultForm에 CSRF hidden 주입
        (function injectCsrfToDefaultForm() {
          const defaultFormEl = $id('defaultForm');
          const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
          const csrfParam = '_csrf';
          if (defaultFormEl && csrfToken) {
            const input = document.createElement('input');
            input.type = 'hidden'; input.name = csrfParam; input.value = csrfToken;
            defaultFormEl.appendChild(input);
          }
        })();
        // 기본 배송지 저장 시 라디오 선택 검증
        $id('defaultForm')?.addEventListener('submit', function (e) {
          const sel = this.querySelector('input[name="addressNo"]:checked');
          if (!sel) { e.preventDefault(); showInfoAlert('기본으로 설정할 배송지를 선택해 주세요.'); }
        });
      }
      if (emptyEl) emptyEl.style.display = 'none';

   // 낙관적 카드 추가(바로 활성 상태)
      const card = document.createElement('div');
      card.className = 'addr-item';
      card.setAttribute('data-address-no', 'temp'); // 서버에서 발급된 진짜 번호 아니므로 temp

      card.innerHTML = `
        <div class="addr-header"><span class="addr-name">${name || '수령인'}</span></div>
        <div class="addr-body">
          <div class="row-line">${($id('addressDetailHidden').value || '').trim() || '—'}</div>
          <div class="row-line">${phone || '—'}</div>
        </div>
        <div class="addr-footer">
          <button type="button" class="addr-edit-btn btn btn-outline-secondary btn-sm"
            data-no="temp" data-name="${name}" data-phone="${phone}"
            data-detail="${($id('addressDetailHidden').value || '').trim()}" data-default="N">수정</button>
          <button type="button" class="addr-delete-btn btn btn-outline-danger btn-sm" data-no="temp">삭제</button>
          <div class="default-ctrl">
            <input type="radio" name="addressNo" value="temp" />
            <label>기본 배송지</label>
          </div>
        </div>`;
      listEl.appendChild(card);


      showSuccessAlert("저장되었습니다.", "/member/address");
      form.reset();
      ['address1','postcode','addressDetailHidden'].forEach(id => { const el = $id(id); if (el) el.value=''; });
      updateAddButtonState();
    } catch (err) {
      if (err && err.status === 401) { location.href = '/member/login'; return; }
      showErrorAlert('저장에 실패했습니다.');
    } finally {
      if (btn) { btn.disabled = false; btn.textContent = '저장'; }
    }
  }

  // 수정 모달 열기
  function openEditModal(btn) {
    const no     = btn.getAttribute('data-no');
    const name   = btn.getAttribute('data-name')   || '';
    const phone  = btn.getAttribute('data-phone')  || '';
    const detail = btn.getAttribute('data-detail') || '';
    const isDef  = (btn.getAttribute('data-default') || 'N') === 'Y';

    $id('editAddressNo').value     = no;
    $id('receiverNameEdit').value  = name;
    $id('receiverPhoneEdit').value = phone;
    $id('addrMainEdit').value      = detail;
    $id('address1Edit').value      = detail;
    $id('postcodeEdit').value      = '';
    $id('addrDetailEdit').value    = '';
    $id('isDefaultEdit').checked   = isDef;

    const modalEl = $id('addressEditModal');
    if (!modalEl) return;
    new bootstrap.Modal(modalEl).show();
  }

  // 수정 저장
  async function saveAddressFromEditModal(btn) {
    try {
      const form    = $id('addrEditForm');
      const no      = $id('editAddressNo').value;
      const name    = $id('receiverNameEdit').value.trim();
      const phone   = $id('receiverPhoneEdit').value.trim();
      const main    = ($id('addrMainEdit').value || '').trim();
      const detail  = ($id('addrDetailEdit').value || '').trim();
      const isDef   = $id('isDefaultEdit').checked;

      if (!form.checkValidity()) { form.reportValidity(); return; }
      if (!main) { showInfoAlert('우편번호 찾기로 주소를 선택하거나 기존 주소를 확인해 주세요.'); return; }

      $id('addressDetailHiddenEdit').value = main + (detail ? ' ' + detail : '');
      if (btn) { btn.disabled = true; btn.textContent = '수정 중…'; }

      const params = new URLSearchParams(new FormData(form));
      if (!isDef) params.delete('isDefault');
      const bodyData = params.toString();

      if (window.jQuery) {
        await new Promise((res, rej) => $.ajax({
          url: '/member/address/edit', method: 'POST', data: bodyData,
          contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
          beforeSend: xhr => { const h = csrfHeaders(); for (const k in h) xhr.setRequestHeader(k, h[k]); },
          success: res, error: rej
        }));
      } else {
        const r = await fetch('/member/address/edit', { method: 'POST', headers: csrfHeaders(), body: bodyData });
        if (!r.ok) { const e = new Error('edit failed'); e.status = r.status; throw e; }
      }

      bootstrap.Modal.getInstance($id('addressEditModal')).hide();

      // 옵티미스틱 UI 갱신
      const card = document.querySelector(`.addr-item[data-address-no="${CSS.escape(no)}"]`);
      if (card) {
        const nm = card.querySelector('.addr-name');
        const lines = card.querySelectorAll('.addr-body .row-line'); // 0=주소, 1=전화
        if (nm) nm.textContent = name || '수령인';
        if (lines[0]) lines[0].textContent = $id('addressDetailHiddenEdit').value || '—';
        if (lines[1]) lines[1].textContent = phone || '—';

        const editBtn = card.querySelector('.addr-edit-btn');
        if (editBtn) {
          editBtn.setAttribute('data-name', name);
          editBtn.setAttribute('data-phone', phone);
          editBtn.setAttribute('data-detail', $id('addressDetailHiddenEdit').value || '');
          editBtn.setAttribute('data-default', isDef ? 'Y' : 'N');
        }

        if (isDef) {
          // 다른 카드 기본 해제
          document.querySelectorAll('.addr-item').forEach(it => {
            if (it === card) return;
            const b = it.querySelector('.badge-chip'); if (b) b.remove();
            const r = it.querySelector('input[type="radio"][name="addressNo"]'); if (r) r.checked = false;
          });
          // 뱃지 보정
          let badge = card.querySelector('.badge-chip');
          if (!badge) {
            badge = document.createElement('span');
            badge.className = 'badge-chip badge-primary';
            badge.textContent = '기본배송지';
            card.querySelector('.addr-header').appendChild(badge);
          }
          // 라디오 체크
          const r = card.querySelector('input[type="radio"][name="addressNo"]');
          if (r) r.checked = true;

          // 맨 위로 이동 + 하이라이트
          const list = $id('addrList');
          if (list && list.firstElementChild !== card) {
            list.insertBefore(card, list.firstElementChild);
            card.style.transition = 'background-color 0.6s';
            const original = getComputedStyle(card).backgroundColor;
            card.style.backgroundColor = '#fff8e1';
            setTimeout(() => { card.style.backgroundColor = original; }, 10);
            setTimeout(() => { card.style.transition = ''; }, 650);
          }
        }
      }

      showSoftBanner('수정 완료. 업데이트 되었습니다.');
    } catch (err) {
      if (err && err.status === 401) { location.href = '/member/login'; return; }
      showErrorAlert('수정에 실패했습니다.');
    } finally {
      if (btn) { btn.disabled = false; btn.textContent = '저장'; }
    }
  }

  // 삭제
  async function deleteAddress(btn) {
    try {
      const no = btn.getAttribute('data-no');
      if (!no) { showErrorAlert('주소 번호가 없습니다.'); return; }

      showConfirmTitleAlert(
        '배송지 삭제',
        '정말 이 배송지를 삭제할까요?<br>삭제 후에는 되돌릴 수 없습니다.',
        async () => {
          btn.disabled = true; btn.textContent = '삭제 중…';
          const bodyData = new URLSearchParams({ addressNo: no }).toString();

          if (window.jQuery) {
            await new Promise((res, rej) => $.ajax({
              url: '/member/address/delete', method: 'POST', data: bodyData,
              contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
              beforeSend: xhr => { const h = csrfHeaders(); for (const k in h) xhr.setRequestHeader(k, h[k]); },
              success: res, error: rej
            }));
          } else {
            const r = await fetch('/member/address/delete', { method: 'POST', headers: csrfHeaders(), body: bodyData });
            if (!r.ok) { const e = new Error('delete failed'); e.status = r.status; throw e; }
          }

          const card = btn.closest('.addr-item');
          const list = $id('addrList');
          if (card) card.remove();

          if (list && list.children.length === 0) {
            const emptyEl = $id('addrEmpty');
            if (emptyEl) emptyEl.style.display = '';
          }

          const first = document.querySelector('#addrList .addr-item');
          if (first && !first.querySelector('.badge-chip')) {
            const badge = document.createElement('span');
            badge.className = 'badge-chip badge-primary';
            badge.textContent = '기본배송지';
            first.querySelector('.addr-header')?.appendChild(badge);
            const r = first.querySelector('input[type="radio"][name="addressNo"]');
            if (r) r.checked = true;
          }

          showSoftBanner('삭제 완료.');
          updateAddButtonState();
        },
        () => {}
      );
    } catch (err) {
      if (err && err.status === 401) { location.href = '/member/login'; return; }
      showErrorAlert('삭제에 실패했습니다.');
    } finally {
      if (btn && btn.disabled) { btn.disabled = false; btn.textContent = '삭제'; }
    }
  }

  // 기본 배송지 저장 라디오 검증(서버 렌더 분기)
  (function enforceDefaultSelect() {
    const defaultForm = $id('defaultForm');
    if (!defaultForm) return;
    defaultForm.addEventListener('submit', function (e) {
      const sel = defaultForm.querySelector('input[name="addressNo"]:checked');
      if (!sel) { e.preventDefault(); showInfoAlert('기본으로 설정할 배송지를 선택해 주세요.'); }
    });
  })();

  // 모달 오픈 전 초기화(추가)
  $id('addressAddModal')?.addEventListener('show.bs.modal', function (e) {
    if (getAddrCount() >= MAX_ADDR) {
      e.preventDefault();
      showInfoAlert('배송지는 최대 5개까지 등록할 수 있습니다.');
      return;
    }
    const form = $id('addrAddForm');
    if (form) form.reset();
    ['address1','postcode','addressDetailHidden'].forEach(id => { const el = $id(id); if (el) el.value=''; });
  });

  // 순수 JS 이벤트 위임(수정/삭제/찾기/저장)
  document.addEventListener('click', function (e) {
    const editBtn = e.target.closest('.addr-edit-btn');
    if (editBtn) { e.preventDefault(); e.stopPropagation(); openEditModal(editBtn); return; }

    const delBtn = e.target.closest('.addr-delete-btn');
    if (delBtn) { e.preventDefault(); e.stopPropagation(); deleteAddress(delBtn); return; }

    const addTrigger = e.target.closest('#addrAddTrigger');
    if (addTrigger) {
      e.preventDefault();
      if (getAddrCount() >= MAX_ADDR) { 
    	  showInfoAlert('배송지는 최대 5개까지 등록할 수 있습니다.'); 
    	  return; 
      }
      if(addModal) addModal.show();
      return;
    }

    const findAdd = e.target.closest('#btnFindAddrAdd');
    if (findAdd) { e.preventDefault(); execDaumPostcodeModal(); return; }

    const findEdit = e.target.closest('#btnFindAddrEdit');
    if (findEdit) { e.preventDefault(); execDaumPostcodeModalEdit(); return; }

    const saveAdd = e.target.closest('#btnSaveAdd');
    if (saveAdd) { e.preventDefault(); saveAddressFromModal(saveAdd); return; }

    const saveEdit = e.target.closest('#btnSaveEdit');
    if (saveEdit) { e.preventDefault(); saveAddressFromEditModal(saveEdit); return; }
  });

  // jQuery AJAX 전역 CSRF (있으면 사용)
  (function () {
    const token  = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
    const header = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');
    if (!token || !header || !window.jQuery) return;
    $(document).ajaxSend(function (e, xhr) { xhr.setRequestHeader(header, token); });
  })();

  // 초기 버튼 상태
  updateAddButtonState();
})();
//모달 닫힐 때 포커스를 트리거 버튼으로 돌려주기
document.addEventListener('DOMContentLoaded', function () {
  const addModal = document.getElementById('addressAddModal');
  const editModal = document.getElementById('addressEditModal');

  if (addModal) {
    addModal.addEventListener('hidden.bs.modal', function () {
      const trigger = document.querySelector('#addrAddTrigger');
      if (trigger) trigger.focus(); // 포커스를 트리거 버튼으로 이동
    });
  }

  if (editModal) {
    editModal.addEventListener('hidden.bs.modal', function () {
      const firstEditBtn = document.querySelector('.addr-edit-btn');
      if (firstEditBtn) firstEditBtn.focus(); // 포커스를 첫 번째 수정 버튼으로 이동
    });
  }
});

</script>
			</div>
		</div>
	</div>
</body>
</html>