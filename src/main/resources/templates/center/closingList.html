<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{common/layout}">

<head>
  <title>폐점 신청</title>
  <meta charset="UTF-8">
  <meta th:name="_csrf" th:content="${_csrf.token}">
  <meta th:name="_csrf_header" th:content="${_csrf.headerName}">
  <link rel="stylesheet" th:href="@{/css/center/help-center.css}">
  <link rel="stylesheet" th:href="@{/css/center/centerSidebar.css}">
  <link rel="stylesheet" th:href="@{/css/center/closing.css}">
</head>

<div layout:fragment="content" class="container my-3">
  <div class="container hc-layout">
    <!-- 좌측 사이드바 -->
    <div th:replace="~{center/centerSidebar :: centerMenu('closing')}"></div>

    <!-- 우측 본문 -->
    <main class="hc-main">
      <h2 class="cl-title">폐점 신청</h2>

      <div class="cl-container box">
        <div th:if="${shop != null}">
          <h3>내 상점 정보</h3>
          <div class="shop-info">
            <p><strong>상점 이름:</strong> <span th:text="${shop.shopName}"></span></p>
            <p><strong>상점 주소:</strong> <span th:text="${shop.shopAddress}"></span></p>
            <p><strong>상점 연락처:</strong> <span th:text="${shop.shopContact}"></span></p>
            <p><strong>상점 소개:</strong> <span th:text="${shop.shopInfo}"></span></p>
            <p><strong>가게 등록일:</strong> <span th:text="${#temporals.format(shop.shopCreatedAt, 'yyyy-MM-dd')}"></span>
            </p>
          </div>

          <div class="closing-warning">
            <h4>폐점 신청 안내</h4>
            <ul>
              <li>폐점 신청 시, 상점은 즉시 폐점 처리됩니다.</li>
              <li>폐점 처리 이후에는 상점 복구가 불가능합니다.</li>
              <li>모든 상품 판매가 중단되며, 정산 절차가 진행됩니다.</li>
              <li>폐점 후에는 점주 권한이 회수되며, 일반 회원으로 전환됩니다.</li>
            </ul>
          </div>

          <form th:action="@{|/center/closing/closing/${shop.shopNo}|}" method="post" class="closing-form">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <input type="hidden" th:value="${shop.shopNo}" />
            <select id="closingReason" name="closingReason" class="form-select mb-2">
              <option value="0">개인 사정(건강, 가족 등)</option>
              <option value="1">경영 문제(매출부진, 원자재 가격상승)</option>
              <option value="2">플랫폼 관련(수수료 부담, 주문량 부족)</option>
              <option value="3">기타</option>
            </select>
            <input type="text" id="etcReasonInput" name="reasonText" class="form-control" placeholder="기타 사유를 입력해주세요"
              style="display: none;" />

            <button type="button" class="btn-close" onclick="handleCloseShop(event)">
              폐점
            </button>
          </form>
        </div>

        <div th:if="${shop == null}" class="no-shop">
          <p>운영 중인 상점이 없습니다.</p>
          <p>점주 회원만 폐점 신청이 가능합니다.</p>
        </div>
      </div>
    </main>
  </div>
</div>

<!--/* 이 페이지에만 적용되는 스크립트 */-->
<th:block layout:fragment="script">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script th:src="@{/js/comm/sweetalert.noah.js}"></script>
  <script>
    const closingReason = document.getElementById('closingReason');
    const etcReasonInput = document.getElementById('etcReasonInput');

    function toggleEtcInput() {
      if (closingReason.value === '3') {
        etcReasonInput.style.display = 'block';
      } else {
        etcReasonInput.style.display = 'none';
        etcReasonInput.value = '';
      }
    }

    // 페이지가 처음 로드될 때 실행
    toggleEtcInput();

    // select 요소의 값이 변경될 때마다 실행
    closingReason.addEventListener('change', toggleEtcInput);
  </script>
  <script>
    function handleCloseShop(e) {
      e.preventDefault(); // 기본 submit 막기

      showConfirmTitleAlert(
        '정말로 폐점 신청을 하시겠습니까?',
        '이 작업은 되돌릴 수 없습니다.',
        () => { // ✅ 확인 클릭 시
          // 실제 폼 전송
          e.target.closest('form').submit();
        },
        () => { // ❌ 취소 클릭 시
          showToast('폐점 신청이 취소되었습니다.', 'info');
        }
      );

      return false; // onClick에서의 기본 동작 방지
    }
  </script>
</th:block>

</html>