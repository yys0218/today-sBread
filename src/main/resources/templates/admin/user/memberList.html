<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{admin/adminLayout}">

<head>
  <link rel="stylesheet" th:href="@{/css/admin/member.css}">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script th:src="@{/js/comm/sweetalert.noah.js}"></script>
</head>
<div layout:fragment="content">

  <h2 class="ml-title">회원 관리</h2>

  <!-- 회원 상태 필터 -->

  <form id="memberSortForm" th:action="@{/admin/user/member/list}" method="get">
    <input type="hidden" name="sortDir" id="sortDir" th:value="${sortDir}" />
    <input type="hidden" name="roleValue" id="roleValue" th:value="${roleValue}" />
    <div name="keyword">
      <input type="text" name="keyword" th:value="${keyword}" placeholder="검색어 입력" />
      <button type="submit">검색</button>
    </div>
    <div class="role-filter">
      <button type="button" th:classappend="${roleValue==null} ? 'active'" onclick="filterByRole('')">전체</button>
      <button type="button" th:classappend="${roleValue==0} ? 'active'" onclick="filterByRole(0)">일반회원</button>
      <button type="button" th:classappend="${roleValue==1} ? 'active'" onclick="filterByRole(1)">판매자</button>
      <button type="button" th:classappend="${roleValue==4} ? 'active'" onclick="filterByRole(4)">라이더</button>
      <button type="button" th:classappend="${roleValue==-1} ? 'active'" onclick="filterByRole(-1)">정지회원</button>
      <button type="button" th:classappend="${roleValue==3} ? 'active'" onclick="filterByRole(3)">탈퇴회원</button>
    </div>
    <!-- 정렬 선택 -->
    <div name="sortField">
      <button type="button" onclick="setSort('memberName')">회원이름</button>
      <button type="button" onclick="setSort('memberReg')">가입일</button>
    </div>
  </form>

  <!-- 레이아웃: 왼쪽 목록 / 오른쪽 상세 -->
  <div class="member-layout">
    <!-- 회원 목록 -->
    <table class="ml-table">
      <thead>
        <tr>
          <th>번호</th>
          <th>아이디</th>
          <th>닉네임</th>
          <th>이름</th>
          <th>성별</th>
          <th>이메일</th>
          <th>상태</th>
          <th>가입일</th>
        </tr>
      </thead>
      <tbody>
        <tr th:each="m : ${paging}" th:data-id="${m.memberNo}" class="member-row" style="cursor:pointer;">
          <td th:text="${m.memberNo}"></td>
          <td th:text="${m.memberId}"></td>
          <td th:text="${m.memberNick}"></td>
          <td th:text="${m.memberName}"></td>
          <td th:text="${m.memberGender}"></td>
          <td th:text="${#strings.substringBefore(m.memberEmail, '.com') + '.com'}"></td>
          <!-- 숫자 출력 후 JS에서 변환 -->
          <td class="list-role" th:text="${m.memberRole}"></td>
          <td th:text="${#temporals.format(m.memberReg, 'yyyy-MM-dd HH:mm')}"></td>
        </tr>
        <tr th:if="${paging.isEmpty()}">
          <td colspan="8" style="text-align:center; color:#999;">
            검색 결과가 없습니다.
          </td>
        </tr>
      </tbody>
    </table>
    <!-- 회원 상세정보 (항상 공간 확보) -->
    <div id="member-detail" class="ml-detail">
      <h3>회원 상세</h3>
      <div id="detail-content">
        왼쪽 목록에서 회원을 선택하세요.
      </div>
    </div>
  </div>

  <!-- 페이징 처리 -->
  <div th:if="${!paging.isEmpty()}">
    <ul class="pagination justify-content-center">

      <!-- 이전 -->
      <span class="page-item" th:if="${paging.hasPrevious()}">
        <a class="page-link"
          th:href="@{|/admin/user/member/list?page=${paging.number-1}&sortField=${sortField}&sortDir=${sortDir}&keyword=${keyword}|}">
          <span>이전</span>
        </a>
      </span>

      <!-- 번호 -->
      <span th:each="page : ${#numbers.sequence(0, paging.totalPages-1)}"
        th:if="${page >= paging.number-5 and page <= paging.number+5}"
        th:classappend="${page==paging.number} ? 'active'" class="page-item">
        <a th:text="${page+1}" class="page-link"
          th:href="@{|/admin/user/member/list?page=${page}&sortField=${sortField}&sortDir=${sortDir}&keyword=${keyword}|}"></a>
      </span>

      <!-- 다음 -->
      <span class="page-item" th:if="${paging.hasNext()}">
        <a class="page-link"
          th:href="@{|/admin/user/member/list?page=${paging.number+1}&sortField=${sortField}&sortDir=${sortDir}&keyword=${keyword}|}">
          <span>다음</span>
        </a>
      </span>

    </ul>
  </div>
  <!-- 페이징 처리 끝 -->


  <!-- 제재 모달 -->
  <div id="restrict-modal" style="display:none;">
    <h4>회원 제재</h4>
    <form id="restrict-form">
      <input type="hidden" id="restrict-memberNo" name="memberNo" />
      <input type="hidden" name="_csrf" th:value="${_csrf.token}" th:name="${_csrf.parameterName}" />
      <label>사유</label>
      <select id="restrict-reason" name="reason" required>
        <option value="0">운영방침 위반</option>
        <option value="1">부적절한 이용행위</option>
        <option value="2">결제관련 문제</option>
        <option value="3">법적 문제</option>
        <option value="4">판매자 피해 누적</option>
      </select>
      <label>기간</label>
      <select id="restrict-type" name="type">
        <option value="3일" data-day="3">3일</option>
        <option value="1주일" data-day="7">1주일</option>
        <option value="1달" data-day="30">1달</option>
        <option value="영구정지" data-day="73048">영구정지</option>
      </select>
      <button type="button" onclick="submitRestrict()">확인</button>
      <button type="button" onclick="closeRestrictModal()">취소</button>
    </form>
  </div>
</div>

<th:block layout:fragment="script">
  <script>
    function filterByRole(role) {
      const form = document.getElementById("memberSortForm");
      document.getElementById("roleValue").value = role; // 선택된 role 값 반영
      form.submit();
    }

    function setSort(field) {
      const form = document.getElementById("memberSortForm");
      const dirInput = document.getElementById("sortDir");
      const currentDir = dirInput.value || "desc";

      // 토글 asc/desc
      const newDir = currentDir === "desc" ? "asc" : "desc";
      dirInput.value = newDir;

      // sortField 반영
      let fieldInput = document.getElementById("sortFieldInput");
      if (!fieldInput) {
        fieldInput = document.createElement("input");
        fieldInput.type = "hidden";
        fieldInput.name = "sortField";
        fieldInput.id = "sortFieldInput";
        form.appendChild(fieldInput);
      }
      fieldInput.value = field;

      form.submit();
    }
  </script>

  <script>
    // 역할 매핑 테이블
    const roleMap = {
      "-1": "정지회원",
      "0": "일반회원",
      "1": "판매자",
      "2": "관리자",
      "3": "탈퇴회원",
      "4": "라이더"
    };

    // 제재 사유 매핑 테이블
    const reasonMap = {
      "0": "운영방침 위반",
      "1": "부적절한 이용행위",
      "2": "결제관련 문제",
      "3": "법적 문제",
      "4": "판매자 피해 누적"
    };

    // 리스트 역할 값 변환
    function applyListRoleMappings() {
      document.querySelectorAll(".list-role").forEach(cell => {
        const code = cell.textContent.trim();
        cell.textContent = roleMap[code] ?? code;
      });
    }

    // detail fragment 매핑 적용
    function applyDetailMappings() {
      const roleSpan = document.getElementById("detail-role");
      if (roleSpan) {
        const code = roleSpan.textContent.trim();
        roleSpan.textContent = roleMap[code] ?? code;
      }

      const reasonSpan = document.getElementById("detail-reason");
      if (reasonSpan) {
        const code = reasonSpan.textContent.trim();
        reasonSpan.textContent = reasonMap[code] ?? code;
      }
    }

    // 모달 열기
    function openRestrictModal(memberNo) {
      document.getElementById("restrict-memberNo").value = memberNo;
      document.getElementById("restrict-modal").style.display = "block";
    }

    // 모달 닫기
    function closeRestrictModal() {
      document.getElementById("restrict-modal").style.display = "none";
      const form = document.getElementById("restrict-form").reset();
      document.getElementById("restrict-memberNo").value = "";
    }

    // 회원 제재
    function submitRestrict() {
      const memberNo = document.getElementById("restrict-memberNo").value;
      const reason = document.getElementById("restrict-reason").value;
      const typeSelect = document.getElementById("restrict-type");
      const type = typeSelect.value;
      const day = typeSelect.options[typeSelect.selectedIndex].getAttribute("data-day");

      const token = document.querySelector("meta[name='_csrf']").getAttribute("content");
      const header = document.querySelector("meta[name='_csrf_header']").getAttribute("content");

      showConfirmTitleAlert(
        '해당 회원을 제재하시겠습니까?',            // 제목
        `${day}일 동안 제재 처리됩니다.`,           // 메시지
        () => { // 확인(제재) 버튼 클릭 시 실행
          fetch(`/admin/user/member/restrict/${memberNo}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
              [header]: token
            },
            body: `reason=${encodeURIComponent(reason)}&type=${encodeURIComponent(type)}&day=${day}`
          })
            .then(res => res.text())
            .then(newRole => {
              showSuccessTitleAlert(
                '제재 완료',
                '회원이 제재되었습니다.'
              );

              // 모달 닫기
              closeRestrictModal();

              // 리스트 값 갱신
              updateMemberRoleInList(memberNo, parseInt(newRole));

              // 상세 정보 최신화
              fetch(`/admin/user/member/detail/${memberNo}`)
                .then(res => res.text())
                .then(html => {
                  document.getElementById("detail-content").innerHTML = html;
                  applyDetailMappings();
                });
            })
            .catch(err => {
              showErrorTitleAlert(
                '오류 발생',
                '제재 처리 중 문제가 발생했습니다.'
              );
            });
        },
        () => { // 취소 버튼 클릭 시 실행
          showToast('제재가 취소되었습니다.', 'info');
        }
      );

    }

    // 회원 제재 취소
    function release(memberNo) {
      const token = document.querySelector("meta[name='_csrf']").getAttribute("content");
      const header = document.querySelector("meta[name='_csrf_header']").getAttribute("content");

      showConfirmTitleAlert(
        '회원 제재를 취소하시겠습니까?',           // 제목
        '해당 회원의 제재 상태가 해제됩니다.',     // 메시지
        () => { // 확인(제재 취소) 클릭 시
          fetch(`/admin/user/member/release/${memberNo}`, {
            method: "POST",
            headers: { [header]: token }
          })
            .then(res => res.text())
            .then(newRole => {
              showSuccessTitleAlert(
                '취소 완료',
                '회원 제재가 해제되었습니다.'
              );

              // 리스트 값 갱신
              updateMemberRoleInList(memberNo, parseInt(newRole));

              // 상세 정보 최신화
              fetch(`/admin/user/member/detail/${memberNo}`)
                .then(res => res.text())
                .then(html => {
                  document.getElementById("detail-content").innerHTML = html;
                  applyDetailMappings();
                });
            })
            .catch(err => {
              showErrorTitleAlert(
                '오류 발생',
                '제재 취소 중 문제가 발생했습니다.'
              );
            });
        },
        () => { // 취소 버튼 클릭 시
          showToast('제재 취소 작업이 중단되었습니다.', 'info');
        }
      );

    }

    // 리스트 역할 값 갱신 (제재/해제 후 실시간 반영)
    function updateMemberRoleInList(memberNo, newRole) {
      const row = document.querySelector(`.member-row[data-id='${memberNo}']`);
      if (row) {
        const roleCell = row.querySelector(".list-role");
        roleCell.textContent = roleMap[String(newRole)] ?? newRole;
      }
    }

    // 초기화
    document.addEventListener("DOMContentLoaded", () => {
      applyListRoleMappings(); // 리스트 처음 로딩 시 변환 실행

      document.querySelectorAll(".member-row").forEach(row => {
        row.addEventListener("click", () => {
          const memberNo = row.getAttribute("data-id");
          fetch(`/admin/user/member/detail/${memberNo}`)
            .then(res => res.text())
            .then(html => {
              document.getElementById("detail-content").innerHTML = html;
              applyDetailMappings(); // 상세 정보 변환 실행
            });
        });
      });
    });
  </script>
  <script th:src="@{/js/admin/admin.js}"></script>
</th:block>


</html>