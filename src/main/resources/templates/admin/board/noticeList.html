<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{admin/adminLayout}">

<head>
  <link rel="stylesheet" th:href="@{/css/admin/notice.css}">
</head>

<div layout:fragment="content">
  <h1 class="nl-title">공지사항 관리</h1>

  <!-- 카테고리 버튼 -->
  <table class="fl-cats">
    <tr>
      <td><button type="button" class="cat-btn" data-category=""
          th:classappend="${category==''} ? ' selected' : ''">(전체)</button></td>
      <td><button type="button" class="cat-btn" data-category="공지"
          th:classappend="${category=='공지'} ? ' selected' : ''">공지</button></td>
      <td><button type="button" class="cat-btn" data-category="점검"
          th:classappend="${category=='점검'} ? ' selected' : ''">점검</button></td>
      <td><button type="button" class="cat-btn" data-category="이벤트"
          th:classappend="${category=='이벤트'} ? ' selected' : ''">이벤트</button></td>
      <td><button type="button" class="cat-btn" data-category="업데이트"
          th:classappend="${category=='업데이트'} ? ' selected' : ''">업데이트</button></td>
    </tr>
  </table>

  <!-- 검색/필터 폼 -->
  <form id="searchForm" th:action="@{/admin/board/notice/list}" method="get" onsubmit="return false;">
    <input type="hidden" name="category" th:value="${category}">
    <input type="text" name="kw" th:value="${kw}" placeholder="검색어">
    <button id="btnSearch" type="button">검색</button>
  </form>

  <!-- 공지 리스트 fragment -->
  <div id="noticeListWrapper" th:fragment="listFragment (paging, category, kw)">
    <table class="nl-table">
      <thead>
        <tr>
          <th>번호</th>
          <th>카테고리</th>
          <th>제목</th>
          <th>작성일</th>
          <th>상태</th>
          <th>관리</th>
        </tr>
      </thead>
      <tbody>
        <tr th:if="${paging.empty}">
          <td colspan="6">게시글이 없습니다.</td>
        </tr>
        <tr th:each="n, loop : ${paging}"
          th:onclick="|location.href='@{/admin/board/notice/detail/{noticeNo}(noticeNo=${n.noticeNo})}'|"
          style="cursor:pointer;">
          <td th:text="${paging.getTotalElements - (paging.number * paging.size) - loop.index}"></td>
          <td th:text="${n.noticeCategory}"></td>
          <td th:text="${n.noticeTitle}"></td>
          <td th:if="${n.noticeUpdateAt == null}" th:text="${#temporals.format(n.noticeAt, 'yyyy-MM-dd HH:mm')}"></td>
          <td th:if="${n.noticeUpdateAt != null}" th:text="${#temporals.format(n.noticeUpdateAt, 'yyyy-MM-dd HH:mm')}">
          </td>
          <td>
            <span th:if="${n.noticeStatus == 0}" class="nl-status nl-status--show">게시중</span>
            <span th:if="${n.noticeStatus == 1}" class="nl-status nl-status--hide">숨김</span>
          </td>
          <td onclick="event.stopPropagation();">
            <a th:href="@{/admin/board/notice/update/{noticeNo}(noticeNo=${n.noticeNo})}">수정</a>
            <a th:href="@{/admin/board/notice/cancel/{noticeNo}(noticeNo=${n.noticeNo})}"
              th:text="${n.noticeStatus == 0 ? '숨김' : '숨김해제'}"></a>
            <a th:href="@{/admin/board/notice/delete/{noticeNo}(noticeNo=${n.noticeNo})}">삭제</a>
          </td>
        </tr>
      </tbody>
    </table>

    <p class="nl-actions">
      <a th:href="@{/admin/board/notice/insert}">글쓰기</a>
    </p>

    <!-- 페이징 처리 -->
    <div th:if="${!paging.isEmpty()}">
      <ul class="pagination justify-content-center">
        <span class="page-item" th:if="${paging.hasPrevious()}">
          <a class="page-link page-link-ajax" href="#" th:attr="data-page=${paging.number-1}">이전</a>
        </span>
        <span th:each="page:${#numbers.sequence(0, paging.totalPages-1)}"
          th:if="${page >= paging.number-5 and page <= paging.number+5}"
          th:classappend="${page==paging.number} ? 'active'" class="page-item">
          <a th:text="${page+1}" class="page-link page-link-ajax" href="#" th:attr="data-page=${page}"></a>
        </span>
        <span class="page-item" th:if="${paging.hasNext()}">
          <a class="page-link page-link-ajax" href="#" th:attr="data-page=${paging.number+1}">다음</a>
        </span>
      </ul>
    </div>
  </div>

  <div layout:fragment="script">
    <script>
      (() => {
        function ready(fn) {
          if (document.readyState !== 'loading') fn();
          else document.addEventListener('DOMContentLoaded', fn);
        }

        ready(() => {
          const searchForm = document.getElementById('searchForm');
          const categoryInput = searchForm.querySelector('input[name="category"]');
          const kwInput = searchForm.querySelector('input[name="kw"]');
          const btnSearch = document.getElementById('btnSearch');
          let listWrapper = document.getElementById('noticeListWrapper');

          // 공통 AJAX
          async function loadNoticeList({ kw, category, page }) {
            const params = new URLSearchParams();
            params.append("kw", kw ?? "");
            params.append("category", category ?? "");
            params.append("page", page ?? 0);

            const resp = await fetch(`${searchForm.getAttribute("action")}?${params.toString()}`, {
              method: "GET"
            });
            const html = await resp.text();
            const frag = new DOMParser().parseFromString(html, "text/html").getElementById("noticeListWrapper");
            if (frag) listWrapper.innerHTML = frag.innerHTML;
          }

          // 카테고리 버튼
          document.addEventListener('click', (e) => {
            const btn = e.target.closest('.cat-btn');
            if (!btn) return;
            const cat = btn.getAttribute('data-category') || '';
            categoryInput.value = cat;

            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');

            loadNoticeList({ kw: kwInput.value, category: cat, page: 0 });
          });

          // 검색 버튼
          btnSearch?.addEventListener('click', () => {
            loadNoticeList({ kw: kwInput.value, category: categoryInput.value, page: 0 });
          });

          // 페이징 (이벤트 위임)
          document.addEventListener('click', (e) => {
            const a = e.target.closest('.page-link-ajax');
            if (!a) return;
            e.preventDefault();
            const page = a.getAttribute('data-page');
            loadNoticeList({ kw: kwInput.value, category: categoryInput.value, page });
          });
        });
      })();
    </script>
  </div>

</html>