<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{admin/adminLayout}">

<head>
    <meta charset="UTF-8">
    <title>ì •ì‚° ì¡°íšŒ í˜ì´ì§€</title>
    <link rel="stylesheet" th:href="@{/css/admin/settle.css}">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script th:src="@{/js/comm/sweetalert.noah.js}"></script>
</head>

<div layout:fragment="content">


    <h2 class="admin-title">ì •ì‚° ë‚´ì—­ ê´€ë¦¬</h2>

    <!-- í˜„ì¬ ì •ì‚° ì„¤ì • -->
    <div class="settle-config-box">
        <p>í˜„ì¬ ë¹µì§‘ ìˆ˜ìˆ˜ë£Œ: <span th:text="${config.shopRatio}">0</span>%</p>
        <p>í˜„ì¬ ë¼ì´ë” ìˆ˜ìˆ˜ë£Œ: <span th:text="${config.riderRatio}">0</span>%</p>
        <button type="button" onclick="openConfigHistoryModal()">ì„¤ì • ë‚´ì—­ ë³´ê¸°</button>
        <button type="button" onclick="openConfigModal()">ì„¤ì • ë³€ê²½</button>
    </div>

    <!-- ì •ì‚° ì„¤ì • -->
    <div id="configModal" class="modal">
        <form method="post" th:action="@{/admin/site/settle/config}">
            <label>ë¹µì§‘ ìˆ˜ìˆ˜ë£Œ</label>
            <input type="number" name="shopRatio" min="0" max="100">
            <label>ë¼ì´ë” ìˆ˜ìˆ˜ë£Œ</label>
            <input type="number" name="riderRatio" min="0" max="100">
            <button type="submit">ì €ì¥</button>
            <button type="button" onclick="closeConfigModal()">ë‹«ê¸°</button>
        </form>
    </div>

    <!-- ì •ë ¬ ì„ íƒ -->
    <form id="settleSortForm" th:action="@{/admin/site/settle/list}" method="get">
        <input type="hidden" name="sortField" id="settleSortField" th:value="${sortField}" />
        <input type="hidden" name="sortDir" id="settleSortDir" th:value="${sortDir}" />

        <div name="sortField" style="margin-bottom: 12px; display:flex; gap:8px;">
            <button type="button" class="btn"
                    th:classappend="${sortField == 'settleNo'} ? 'active ' + (${sortDir == 'ASC'} ? 'asc' : 'desc') : ''"
                    onclick="setSettleSort('settleNo')">ë²ˆí˜¸</button>
            <button type="button" class="btn"
                    th:classappend="${sortField == 'settleAmt'} ? 'active ' + (${sortDir == 'ASC'} ? 'asc' : 'desc') : ''"
                    onclick="setSettleSort('settleAmt')">ê¸ˆì•¡</button>
            <button type="button" class="btn"
                    th:classappend="${sortField == 'settleAt'} ? 'active ' + (${sortDir == 'ASC'} ? 'asc' : 'desc') : ''"
                    onclick="setSettleSort('settleAt')">ì¼ì</button>
        </div>
    </form>

    <!-- ì •ì‚° ë‚´ì—­ í…Œì´ë¸” -->
    <table class="admin-table">
        <thead>
            <tr>
                <th>ë²ˆí˜¸</th>
                <th>êµ¬ë¶„</th>
                <th>ì´ë¦„</th>
                <th>ê¸ˆì•¡</th>
                <th>ìˆ˜ìˆ˜ë£Œ</th>
                <th>ì¼ì</th>
            </tr>
        </thead>
        <tbody>
            <tr th:each="s : ${settleList}">
                <td th:text="${s.settleNo}"></td>
                <td th:text="${s.settleType==1?'ë¹µì§‘':'ë¼ì´ë”'}"></td>
                <td th:text="${s.settleName}"></td>
                <td th:text="${s.settleAmt} + 'ì›'"></td>
                <td th:text="${s.settleCharge} + 'ì›'"></td>
                <td th:text="${#temporals.format(s.settleAt, 'yyyy-MM-dd HH:mm')}"></td>
            </tr>
        </tbody>
    </table>

    <!-- í˜ì´ì§• ì²˜ë¦¬ (ê·¸ëŒ€ë¡œ ë‘ë˜ .pagination CSSê°€ ì…í˜€ì§) -->

    <!-- ì •ì‚° ì„¤ì • ë‚´ì—­ ëª¨ë‹¬ -->
    <div id="configHistoryModal" class="modal">
        <h3>ì •ì‚° ì„¤ì • ë‚´ì—­</h3>
        <table>
            <thead>
                <tr>
                    <th>ë³€ê²½ì¼ì</th>
                    <th>ë¹µì§‘ ìˆ˜ìˆ˜ë£Œ</th>
                    <th>ë¼ì´ë” ìˆ˜ìˆ˜ë£Œ</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="h : ${configHistory}">
                    <td th:text="${#temporals.format(h.updatedAt, 'yyyy-MM-dd HH:mm')}"></td>
                    <td th:text="${h.shopRatio + '%'}"></td>
                    <td th:text="${h.riderRatio + '%'}"></td>
                </tr>
            </tbody>
        </table>
        <button type="button" onclick="closeConfigHistoryModal()">ë‹«ê¸°</button>
    </div>

</div>



<th:block layout:fragment="script">
    <script>
        // ğŸ”¹ ëª¨ë“  ëª¨ë‹¬ ë‹«ê¸°
        function closeAllModals() {
            document.querySelectorAll(".modal").forEach(modal => {
                modal.style.display = "none";
            });
        }

        function openConfigModal() {
            closeAllModals(); // ë‹¤ë¥¸ ëª¨ë‹¬ ë‹«ê¸°
            const modal = document.getElementById("configModal");
            if (modal) {
                modal.style.display = "block";
            } else {
                showWarningAlert("ì„¤ì • ëª¨ë‹¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", null);
            }
        }

        function closeConfigModal() {
            const modal = document.getElementById("configModal");
            if (modal) {
                modal.style.display = "none";
            }
        }

        function openConfigHistoryModal() {
            closeAllModals(); // ë‹¤ë¥¸ ëª¨ë‹¬ ë‹«ê¸°
            document.getElementById("configHistoryModal").style.display = "block";
        }

        function closeConfigHistoryModal() {
            document.getElementById("configHistoryModal").style.display = "none";
        }
    </script>

    <script>
        function setSettleSort(field) {
            const form = document.getElementById("settleSortForm");
            const fieldInput = document.getElementById("settleSortField");
            const dirInput = document.getElementById("settleSortDir");

            // ì •ë ¬ í•„ë“œ ì§€ì •
            fieldInput.value = field;

            // í˜„ì¬ ë°©í–¥ ê°’ ì½ê¸° (ì—†ìœ¼ë©´ DESC ê¸°ë³¸)
            const currentDir = dirInput.value || "DESC";
            // í† ê¸€ asc/desc
            const newDir = (currentDir === "DESC") ? "ASC" : "DESC";
            dirInput.value = newDir;

            form.submit();
        }
    </script>
    <script th:src="@{/js/admin/admin.js}"></script>
</th:block>

</html>