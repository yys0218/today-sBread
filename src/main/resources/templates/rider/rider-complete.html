<!--
******************************************
*  Created On : 2025. 8. 12.
*  File : rider-all-view.html
*******************************************
-->

<html layout:decorate="~{rider/rider-layout1}">
    <!-- 페이지 전용 CSS 주입 -->
    <th:block layout:fragment="head-extra">
        <!-- 외부 CSS -->
        <!-- <link rel="stylesheet" th:href="@{/css/rider-page.css}"> -->
        <!-- 혹은 인라인 스타일 -->
        <link rel="stylesheet" th:href="@{/css/rider/riderComplete.css}" />
    </th:block>

    <!-- side_bar 영역 시작 -->
    <div layout:fragment="side_bar">
        <!-- rider의 정보 출력용 div-->
        <div>
            <div class="rider_Info">
                <div class="info_time">
                    <span class="timezone">
                        <span class="timezone_hour"></span>
                        :
                        <span class="timezone_min"></span>
                        :
                        <span class="timezone_sec"></span>
                    </span>
                </div>
                <div class="info_id">
                    <span th:text="|#${#authentication.principal.username} 님 |"></span>
                </div>
            </div>
            <div>
                <div class="delivery_info card mt-3">
                    <div class="step requested done">
                        <div class="time">14:00</div>
                        <div class="circle"></div>
                        <div class="label">요청</div>
                    </div>
                    <div class="step assigned active">
                        <div class="time">15:30</div>
                        <div class="circle"></div>
                        <div class="label">배차</div>
                    </div>
                    <div class="step pickup">
                        <div class="time"></div>
                        <div class="circle"></div>
                        <div class="label">픽업</div>
                    </div>
                    <div class="step">
                        <div class="time"></div>
                        <div class="circle"></div>
                        <div class="label">완료</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="delivery_detail card px-3 mt-3">
            <div class="delivery_title">
                <span>금액</span>
                <div class="d-flex">
                    <input type="text" name="orderPrice" id="orderPrice" class="custom-h-input order-price" />
                </div>
            </div>
            <div class="delivery_title">
                <span>고객연락처</span>
                <div class="d-flex">
                    <input type="text" name="orderPhone" id="orderPhone" class="custom-h-input" />
                </div>
            </div>
            <div class="delivery_title">
                <span>배달주소</span>
                <div id="delivery_address"></div>
            </div>
            <div class="delivery_title flex-column">
                <span>고객 메모</span>
                <div>
                    <div class="order-box order-request"></div>
                </div>
            </div>
            <div class="delivery_title flex-column">
                <span>주문 내역</span>
                <div>
                    <div class="order-box order-details"></div>
                </div>
            </div>
        </div>

        <script>
            // jQuery가 로드된 뒤 실행
            $(function () {
                function tickOne($box) {
                    const tz = $box.data('tz') || Intl.DateTimeFormat().resolvedOptions().timeZone;
                    const fmt = new Intl.DateTimeFormat('ko-KR', {
                        timeZone: tz,
                        hour12: false,
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                    });
                    const parts = fmt.formatToParts(new Date());
                    const map = {};
                    parts.forEach((p) => (map[p.type] = p.value));

                    $box.find('.timezone_hour').text(map.hour);
                    $box.find('.timezone_min').text(map.minute);
                    $box.find('.timezone_sec').text(map.second);
                }

                function tickAll() {
                    $('.timezone').each(function () {
                        tickOne($(this));
                    });
                }

                tickAll(); // 즉시 1회
                setInterval(tickAll, 1000); // 1초마다 갱신
            });
        </script>
    </div>
    <!-- side_bar 영역 끝 -->

    <!-- content 영역 시작 -->
    <div layout:fragment="content" class="content-start" data-order-type="complete">
        <th:block th:replace="~{rider/orderFragment :: orderList}"></th:block>
        <th:block th:replace="~{rider/deliveryModalFragment :: deliveryModal}"></th:block>
        <!-- <div>
            <button type="button" id="callBtn">하하</button>
            <button type="button" id="chackApiBtn">
                새로고침
                <i class="bi bi-arrow-clockwise"></i>
            </button>
        </div> -->
        <script src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey=HF54XgP4IDasImIzZ2bEPahklEFoB35z75mPPfbE"></script>
        <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=2b3cab747d17c7336deeb3bf01f35e09&libraries=services,clusterer,drawing"></script>
        <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.7/kakao.min.js" integrity="sha384-tJkjbtDbvoxO+diRuDtwRO9JXR7pjWnfjfRn5ePUpl7e7RJCxKCwwnfqUAdXh53p" crossorigin="anonymous"></script>
        <script src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey=HF54XgP4IDasImIzZ2bEPahklEFoB35z75mPPfbE"></script>
        <script th:inline="javascript"></script>
        <!-- <script>
            function getCoordinates(address, callback) {
                $.ajax({
                    url: 'https://apis.openapi.sk.com/tmap/geo/fullAddrGeo',
                    type: 'GET',
                    data: {
                        version: 1,
                        format: 'json',
                        coordType: 'WGS84GEO',
                        fullAddr: address,
                        appKey: 'HF54XgP4IDasImIzZ2bEPahklEFoB35z75mPPfbE', // 반드시 REST API 키
                    },
                    success: function (data) {
                        console.log(data);

                        if (data.coordinateInfo && data.coordinateInfo.coordinate.length > 0) {
                            const info = data.coordinateInfo.coordinate[0];
                            const lat = info.newLat;
                            const lon = info.newLon;

                            console.log('주소:', address);
                            console.log('위도(lat):', lat);
                            console.log('경도(lon):', lon);
                            callback({ lat, lon });
                        } else {
                            console.log('좌표를 찾을 수 없습니다.');
                            callback(null);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('API 호출 오류:', status, error);
                        callback(null);
                    },
                });
            }

            // 경로 탐색
            function searchRoute(start, end) {
                $.ajax({
                    url: 'https://apis.openapi.sk.com/tmap/routes?version=1&format=json',
                    type: 'POST',
                    headers: {
                        appKey: 'HF54XgP4IDasImIzZ2bEPahklEFoB35z75mPPfbE',
                        'Content-Type': 'application/json',
                    },
                    data: JSON.stringify({
                        startX: start.lon,
                        startY: start.lat,
                        endX: end.lon,
                        endY: end.lat,
                        reqCoordType: 'WGS84GEO',
                        resCoordType: 'WGS84GEO',
                        searchOption: 0, // 0: 추천, 2: 최소시간, 10: 최단거리
                    }),
                    success: function (data) {
                        console.log(data);

                        const info = data.features[0].properties;
                        console.log(`예상 시간: ${(info.totalTime / 60).toFixed(0)}분\n` + `거리: ${(info.totalDistance / 1000).toFixed(1)} km\n` + `통행 요금: ${info.totalFare}원\n` + `택시 요금: ${info.taxiFare}원`);
                    },
                    error: function (xhr, status, error) {
                        console.error('경로 탐색 실패:', status, error);
                        alert('경로 탐색 실패');
                    },
                });
            }

            $('#chackApiBtn').on('click', function () {
                const address = '경기도 부천시 소사로 327번길 15 102호';
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function (position) {
                        var riderLat = position.coords.latitude; // 위도
                        var riderLng = position.coords.longitude; // 경도

                        riderX = riderLat;
                        riderY = riderLng;
                        let startCoord = { lat: riderX, lon: riderY };
                        getCoordinates(address, function (endCoord) {
                            if (!endCoord) return;
                            console.log('startCoord : ' + JSON.stringify(startCoord));
                            console.log('endCoord : ' + JSON.stringify(endCoord));
                            searchRoute(startCoord, endCoord);
                        });
                    });
                }
            });
        </script> -->
        <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=2b3cab747d17c7336deeb3bf01f35e09&libraries=services"></script>
        <script>
            $('.nav_item').removeClass('active');
            $('.nav_item').eq(4).addClass('active');
            function getURL(startX, startY, endX, endY) {
                // 기본 API 요청 호출 주소
                let base = 'https://apis-navi.kakaomobility.com/v1/directions?';
                // 필수 파라미터 (출발지, 도착지) → 경도(X), 위도(Y) 순서
                let origin = 'origin=' + startX + ',' + startY + ',name=출발지';
                let destination = '&destination=' + endX + ',' + endY + ',name=도착지';

                // 선택 파라미터 (원하는 옵션 추가 가능)
                // 1. 경유지 (waypoints) waypoints=경유지1의X,경유지1의Y,name=경유지1
                // 경유지는 최대 5개 까지 지정 가능
                // 여러 개일 경우 "|" 또는 "%7C" 로 구분
                let waypoints = '&waypoints=127.115,37.393,name=경유지1|127.117,37.395,name=경유지2';

                // 2. 경로 탐색 우선순위 (priority)
                // 설정 안할시 RECOMMEND (기본값:추천 경로)
                // - RECOMMEND (추천 경로)
                // - TIME (최단 시간)
                // - DISTANCE (최단 거리)
                let priority = '&priority=TIME'; // 최단 시간 기준

                // 3. avoid (회피 옵션)
                // - motorway (자동차 전용 도로)
                // - toll (유료 도로)
                // - ferries (페리 항로)
                // - schoolzone (어린이 보호구역)
                // - uturn (유턴)
                // → 여러 개는 '|' 로 연결 가능
                let avoid = '&avoid=motorway|ferries'; // 고속도로, 페리 회피

                // 4. roadevent (유고 정보 반영 여부)
                // 설정 안할 시 0 기본값
                // - 0 (기본값: 도로 통제 전부 반영)
                // - 1 (출발/도착지 주변 통제는 반영 안 함)
                // - 2 (모든 도로 통제 반영 안 함)
                let roadevent = '&roadevent=0'; // 기본값: 도로 통제 반영

                // 5. alternatives (대체 경로 제공 여부)
                // - true (대체 경로도 함께 제공)
                // - false (기본 경로만 제공, 기본값)
                let alternatives = '&alternatives=true'; // 대체 경로 제공

                // 6. road_details (상세 도로 정보 제공 여부)
                // - true (상세 도로 정보 포함)
                // - false (기본값, 포함하지 않음)
                let road_details = '&road_details=true'; // 상세 도로 정보

                // 7. car_type (차종)
                // - 1 (승용차, 기본값)
                // - 2 (버스)
                // - 3 (택시)
                // - 4 (화물차)
                // - 5 (이륜차)
                let car_type = '&car_type=1'; // 승용차

                // 8. car_fuel (연료 종류)
                // - GASOLINE (휘발유, 기본값)
                // - DIESEL (경유)
                // - LPG (LPG)
                let car_fuel = '&car_fuel=GASOLINE'; // 휘발유

                // 9. car_hipass (하이패스 장착 여부)
                // - true (하이패스 장착)
                // - false (미장착, 기본값)
                let car_hipass = '&car_hipass=true'; // 하이패스 장착

                // 10. summary (요약 정보만 제공 여부)
                // - true (요약 정보만 제공)
                // - false (상세 정보 포함, 기본값)
                let summary = '&summary=false'; // 요약정보 X, 상세 포함

                let url = base + origin + destination + waypoints + priority + avoid + roadevent + alternatives + road_details + car_type + car_fuel + car_hipass + summary;
                return url;
            }

            $('#callBtn').on('click', async function () {
                let shopX;
                let shopY;
                try {
                    const loc = await getLoc('서울 광진구 긴고랑로13길 35-4');

                    shopX = loc.x;

                    shopY = loc.y;
                } catch (err) {
                    console.error(err);
                }
            });
            var geocoder = new kakao.maps.services.Geocoder();

            // 주소 -> 좌표 변환
            var callback = function (result, status) {
                if (status === kakao.maps.services.Status.OK) {
                }
            };
            $('#chackApiBtn').on('click', function () {
                let shopX;
                let shopY;
                let riderX;
                let riderY;
                geocoder.addressSearch('서울 구로구 경인로 390 고척동 벽산블루밍 211-503', function (result, status) {
                    shopX = result[0].x;
                    shopY = result[0].y;
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            function (position) {
                                var riderLng = position.coords.longitude; // 경도
                                var riderLat = position.coords.latitude; // 위도

                                riderX = riderLng; // 경도
                                riderY = riderLat; // 위도

                                // 여기서 라이더 와 가게의 좌표로 kakaomobility를 사용해서 최적 거리 계산 및 화면 출력
                                //fetch(`https://apis-navi.kakaomobility.com/v1/directions?origin=${riderY},${riderX},name=라이더&destination=${shopY},${shopX},name=가게&car_type=5`, {
                                fetch(`https://apis-navi.kakaomobility.com/v1/directions?origin=${riderX},${riderY},name=라이더&destination=${shopX},${shopY},name=가게&car_type=5`, {
                                    method: 'GET',
                                    headers: {
                                        Authorization: 'KakaoAK ' + '7571a89ec04aa50beea0a887b9da0519',
                                    },
                                })
                                    .then((response) => response.json())
                                    .then((data) => {
                                        let distance = data.routes[0].summary.distance; // 미터 단위
                                        let duration = data.routes[0].summary.duration; // 초 단위
                                    })
                                    .catch((err) => console.error(err));
                            },
                            function (error) {
                                console.error('위치 정보를 가져올 수 없습니다.', error);
                            }
                        );
                    } else {
                        alert('이 브라우저는 Geolocation을 지원하지 않습니다.');
                    }
                });
            });
        </script>
    </div>

    <!-- content 영역 끝 -->
</html>
