<html layout:decorate="~{common/layout}">	<!--layout.html을 include한 셈-->
<head>
	<!-- summernote.css-->
	<link href="https://cdn.jsdelivr.net/npm/summernote@0.8.20/dist/summernote-bs5.min.css" rel="stylesheet">
	<!-- summernote js, 한글화 js -->
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.20/dist/summernote-bs5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/lang/summernote-ko-KR.min.js"></script>
	<!-- insertForm.css -->
	<link rel="stylesheet" th:href="@{/css/product/insertForm.css}" />
<!-- ajax 접근권한(CSRF헤더) 부여용 -->
	<th:block>
        <meta name="_csrf" th:content="${_csrf.token}">
        <meta name="_csrf_header" th:content="${_csrf.headerName}">
    </th:block>	
</head>
<div layout:fragment="content" class="container my-3"><!-- 아래가 레이아웃 content 부분에 담김 -->
	  <!-- 본문 제목 -->
	  <section class="top text-center">
	      <h1>상품수정</h1>  
	  </section>
	  
	  <!-- 페이지 본문 박스 -->
      <a class="btn btn-secondary m-2" type="button" th:href="@{/shop/shopmain}">상점으로</a>
	  <div class="box insertForm">
	      <form th:object="${productInsertForm}" th:action="@{/product/update}" method="post" enctype="multipart/form-data">
		      <!-- 유효성 검사 후 에러 있을 경우 경고문 -->
		      <div th:replace="~{/error/formErrors :: formErrorsFragment}"></div>
		      <div th:if="${#fields.hasGlobalErrors()}">
		      	<div th:each="err : ${#fields.globalErrors()}" th:text="${err}"></div>
		      </div>
		      <input type="hidden" th:field="*{shopNo}" /><!-- productInsertForm에 저장된 값 전달용 -->
		      <input type="hidden" th:field="*{memberNo}" /><!-- productInsertForm에 저장된 값 전달용 -->
		      <input type="hidden" th:field="*{productNo}" id="productNo"/><!-- productInsertForm에 저장된 값 전달용 -->
	     
	      <div class="insertForm_top d-flex">
			<div class="insertForm_images w-50">
		    	<div class="insertForm_images_title d-flex ms-3">
			    	<h3><label for="btn-uploadedFile">상품 사진</label></h3>
				</div>
		        <span>*상품 사진은 수정이 불가합니다.</span>
		        <div class="d-flex flex-wrap">
			    	<div class="uploadedFiles" th:each="name : ${fileNames}">
						<img th:src="@{|/upload/product/${name}|}" class="rounded border me-1" style="width:150px"/>
			        </div>
			        <input type="hidden" name="countFiles" value="1"/><!-- 유효성검사 통과용 -->
				</div>
			</div>	
			<div class="insertForm_data w-50">
				<h3>상품 정보</h3>
				<div class="d-flex justify-content-between">
					<div class="mt-2">
						<div class="mb-2">
			              <label for="productName">상품명</label><br>
			              <input type="text" th:field="*{productName}" id="productName" maxlength="30" placeholder="최대 30자"/>
						</div>
						<div class="mb-1">
			              <label for="productSummary">상품 한 줄 소개</label><br>
			              <textarea type="text" th:field="*{productSummary}" id="productSummary" maxlength="300" placeholder="최대 300자" cols="25" rows="3">
			              </textarea>
						</div>
						<div class="mb-2">
			              <label for="productPrice">상품가격</label><br>
			              <input type="number" th:field="*{price}" id="price" maxlength="9" min="0" max="100000000" oninput="checkLength(this);" />
						</div>
			      		<div class="mb-2">
			              <label for="categoryMain">카테고리</label><br>
			              <select th:field="*{categoryMain}" id="categoryMain" onchange="changeCate(this.value);"><!-- 카테고리 대분류 -->
			              	<option value="" selected hidden>대분류</option>
			              	<span th:each="cate : ${category}" th:if="${cate.depth==0}"><!-- 대분류일 때만 반복 출력 -->
			                	<option th:value="${cate.categoryCode}" th:text="${cate.categoryName}"></option>
			              	</span>
			              </select>
			     	  	  <select th:field="*{categorySub}" id="categorySub"><!-- 카테고리 소분류 -->
			     	  	  	<option value="" selected hidden>소분류</option>
			              	<span th:each="cate : ${category}" th:if="${cate.depth==1}"><!-- 소분류만 반복 출력 -->
			                	<option th:value="${cate.categoryCode}" th:text="${cate.categoryName}"></option>
			              	</span>		     	  	  	
			              </select>
						</div>
					</div>
					<div class="me-3">
						<div class="mt-1">
			              <label for="allergyInfo">알레르기 정보</label><br>
			              <textarea th:field="*{allergyInfo}"  id="allergyInfo" maxlength="300" placeholder="최대 300자" cols="25" rows="3"></textarea>
						</div>
						<div>
			              <label for="nutritionInfo">영양성분</label><br>
			              <textarea th:field="*{nutritionInfo}"  id="allergyInfo" maxlength="300" placeholder="최대 300자" cols="25" rows="3"></textarea>
						</div>
						<div>
							<label for="isSubscription" class="mb-1">정기 결제 상품입니다.</label>
							<input type="checkbox" id="isSubscription" th:field="*{isSubscription}" value="1"/>
						</div>
						<input type="reset" class="btn btn-secondary rewriteInfo" value="다시 입력" />
					</div>
				</div>
	      	</div>
	      </div>
	      					
	      <div class="insertForm_bottom m-3">
	      	<h3><label for="summernote">상세 정보</label></h3>
		    <p>※상품의 상세 정보에 출력됩니다.</p>
	        <textarea th:field="*{productInfo}" id="summernote"></textarea>
		      	<button type="button" class="btn btn-secondary mb-2 mt-2" id="resetBtn">지우기</button>
		  </div>
			<div class="text-center m-3">
				<input type="submit" class="btn btn-warning w-25" value="등록" />
			</div>
		   </form>
	  	</div><!-- 페이지 본문 박스 -->
 </div><!-- fragment:content 종료 -->
 
 
<script layout:fragment="script" type="text/javascript" th:inline="javascript">

// 모든 jQuery AJAX 요청에 CSRF 헤더 자동 첨부
$(function () {
  const token  = $('meta[name="_csrf"]').attr('content');
  const header = $('meta[name="_csrf_header"]').attr('content');
  $(document).ajaxSend(function (e, xhr) {
    if (token && header) xhr.setRequestHeader(header, token);
  });
});

	//summernote 호출
	$(function(){ //문서가 준비되면
		$('#summernote').summernote({ //summernote선택자에 summernote 호출
			maxwidth: 1000, //너비
			minwidth: 700,
			height: 450,	 //높이
			minHeight: 450, //최소높이
			maxHeight: 800,  //최대높이
			focus: true, //초기화 시 자동으로 입력창 안으로 포커스가 가도록
			lang: 'ko-KR', //한글화

			//styleWithCSS: true, //html태그가 아닌 css스타일을 사용하여 텍스트 서식을 지정
		callbacks: { //callback함수
			onInit: function(){ //onInit함수
				$('#resetBtn').on('click',function(){ //선택자 클릭 시 
					$('#summernote').summernote('reset'); //#summernote에 입력된 내용 reset					
				});
				$('.note-editable').css('background-color','white'); //입력창.배경색 흰색으로
		        $('#summernote').summernote('formatPara'); //기본 좌측정렬로 만들어주는 함수
		        $('#summernote').summernote('justifyCenter');

			},//onInit 종료
		
			onImageUpload: function(files){ //summertnote가 이미지 업로드 시 호출 files=선택된 파일(들)
				const formData = new FormData(); //ajax로 전송될 데이터를 담는 formData
				for(let i =0; i < files.length; i++){
					formData.append("files", files[i]); //formData에 업로드할 사진 담기				
				}
				//썸머노트 이미지 업로드 요청
				$.ajax({
					url: '/product/summernoteImg',
					type: 'POST',
					data: formData,
					contentType: false, //formData전송에 필요
					processData: false, //formData전송에 필요
					success: function(url){ //summernote내용으로 반환되는 이미지의 주소
						$('#summernote').summernote('insertImage', "/upload/productInfo/"+url); //이미지 삽입 시 리턴된 주소 사용
					},
					error: function(xhr,status,error){ //xhr,status,error
						console.error("오류 상태 코드: "+xhr.status + "메시지: "+xhr.responseText);
						showErrorAlert("이미지 업로드에 실패했습니다.");
					}
				});//썸머노트 이미지 업로드 요청 종료
			}//onImageUpload 종료
		},//callback함수 종료
		disableDragAndDrop: true // 업로드된 이미지의 주소가 base64형식으로 리턴되는 것 방지(글자 수가 길어지는 것 방지)		
		}); //summernote설정
	}); //summernote호출 종료
	
    //number타입 input의 입력값 제한
    function checkLength(num){ //num=input에 입력된 값
    	if(num.value.length > num.maxLength){ //입력된 값의 길이가 지정된 최대길이보다 크다면
    		num.value = num.value.slice(0, num.maxLength); //최대길이만큼 값 자르기
    	}
    }
    
    //카테고리 구분 - 대분류에 따라 소분류 출력   
	function changeCate(cateCode){ //대분류 값이 바뀔 때, 매개변수: cateCode = 대분류의 categoryCode
	
    	let categoryList = /*[[${category}]]*/[]; //카테고리List를 자바스크립트에서 쓸 수있도록 JSON형식으로 변환
		
		//소분류<select>의 기존 <option>초기화 (옵션을 다시 선택할 경우)
		$('#categorySub').empty();
		
		//대분류의 code와 parentCode가 일치하는 소분류만 추가
		$.each(categoryList, function(i,cate){ //제이쿼리의 반복문(cate = categoryList[i])
			if(cate.parentCode == cateCode){ //cate의 parentCode가 cateCode와 일치한다면(대분류의 categoryCode와 일치하는 parentCode를 가진 소분류)
				$('#categorySub').append( //소분류<select>에 태그 추가
						$("<option>").val(cate.categoryCode).text(cate.categoryName) //value=categoryCode이고, text=categoryName인 <option>
				);		
			}
		});//소분류 반복문 종료
    }
    
  </script>
</html>
